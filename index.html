<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Financial Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1a1a;
            font-size: 14px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .client-name {
            font-style: italic;
            font-size: 18px;
            opacity: 0.9;
        }

        .main-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .module-card {
            background: white;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .module-card:active {
            transform: scale(0.95);
        }

        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.9;
            border-radius: 20px;
        }

        .module-card.income::before { background: linear-gradient(135deg, #4ade80, #22c55e); }
        .module-card.expense::before { background: linear-gradient(135deg, #f87171, #ef4444); }
        .module-card.lend::before { background: linear-gradient(135deg, #38bdf8, #0ea5e9); }
        .module-card.borrow::before { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .module-card.emi::before { background: linear-gradient(135deg, #c084fc, #a855f7); }
        .module-card.stats::before { background: linear-gradient(135deg, #94a3b8, #64748b); }
        .module-card.debit-cards::before { background: linear-gradient(135deg, #10b981, #059669); }
.module-card.credit-cards::before { background: linear-gradient(135deg, #f97316, #ea580c); }
        .module-card.investments::before { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .module-card h2 {
            font-size: 24px;
            font-weight: 900;
            font-style: italic;
            color: black;
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.3);
        }

        .detail-view {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .detail-view.active {
            display: block;
        }


        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-btn {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .section-header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            font-style: italic;
            margin-bottom: 10px;
        }

        .add-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .add-btn:active {
            transform: scale(0.95);
        }

        .form-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-actions {
            display: flex;
            gap: 15px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
        }

        .btn-primary:active,
        .btn-secondary:active {
            transform: scale(0.95);
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .item-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            border-left: 4px solid;
            position: relative;
        }

        .item-card.income { border-left-color: #22c55e; }
        .item-card.expense { border-left-color: #ef4444; }
        .item-card.lend { border-left-color: #0ea5e9; }
        .item-card.borrow { border-left-color: #f59e0b; }
        .item-card.emi { border-left-color: #a855f7; }
.item-card.debit-cards { border-left-color: #059669; }
.item-card.credit-cards { border-left-color: #ea580c; }
.item-card.investments { border-left-color: #7c3aed; }

        .item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .item-amount {
            font-size: 20px;
            font-weight: 800;
            color: #059669;
        }

        .item-amount.expense,
        .item-amount.borrow {
            color: #dc2626;
        }

        .item-details {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-edit,
        .btn-delete {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hidden {
            display: none !important;
        }

     .history-toggle {
    color: #3b82f6;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
    text-decoration: underline;
}

.history-toggle:hover {
    color: #1d4ed8;
}

.history-content {
    max-height: 60px;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.history-content.expanded {
    max-height: 500px;
}

.history-item {
    margin-left: 10px;
    font-size: 12px;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}

.module-card.documents::before { 
    background: linear-gradient(135deg, #ec4899, #db2777);
    grid-column: span 3;
}

.module-card.documents {
    grid-column: span 3;
    min-height: 80px;
    padding: 25px 20px;
}

.module-card.documents h2 {
    font-size: 28px;
    text-shadow: 2px 2px 4px rgba(255,255,255,0.4);
}
.main-container {
    padding: 20px;
    max-width: 1000px; /* Increased from 500px to accommodate 3 columns */
    margin: 0 auto;
}

#documents-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    padding: 20px 0;
    width: 100%;
}

.document-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    border-left: 4px solid #db2777;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* Floating Calculator */
.floating-calculator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 50%;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    cursor: move;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    z-index: 1000;
    transition: all 0.3s ease;
}

.floating-calculator:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
}

.calculator-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
}

.calculator-container {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 280px;
    cursor: move;
}

.calculator-display {
    width: 100%;
    height: 60px;
    font-size: 24px;
    text-align: right;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 0 15px;
    margin-bottom: 15px;
    background: #f9fafb;
}

.calculator-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
}

.calc-btn {
    height: 50px;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.calc-btn:hover {
    transform: scale(1.05);
}

.calc-btn.number {
    background: #f3f4f6;
    color: #1f2937;
}

.calc-btn.operator {
    background: #3b82f6;
    color: white;
}

.calc-btn.equals {
    background: #22c55e;
    color: white;
}

.calc-btn.clear {
    background: #ef4444;
    color: white;
}

.calculator-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.calculator-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.calculator-close {
    width: 30px;
    height: 30px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #6b7280;
}

.calculator-close:hover {
    background: #e5e7eb;
}



@media (max-width: 480px) {
    .main-container {
        padding: 15px;
    }

    .dashboard-grid {
        gap: 15px;
    }

    .module-card {
        padding: 30px 15px;
        min-height: 120px;
    }

    .module-card h2 {
        font-size: 20px;
    }

    .form-container {
        padding: 20px;
    }

}   
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <div class="logo">LOGO</div>
            <div>
                <h1>FINANCIAL MANAGER OF</h1>
                <div class="client-name" id="clientName">Sudipto Ghosh</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div id="dashboard" class="dashboard-view">
<div class="dashboard-grid" style="grid-template-columns: 1fr 1fr 1fr;">
    <div class="module-card income" onclick="showModule('income')">
        <h2>INCOME</h2>
    </div>
    <div class="module-card expense" onclick="showModule('expense')">
        <h2>EXPENSE</h2>
    </div>
    <div class="module-card lend" onclick="showModule('lend')">
        <h2>LEND</h2>
    </div>
    <div class="module-card borrow" onclick="showModule('borrow')">
        <h2>BORROW</h2>
    </div>
    <div class="module-card emi" onclick="showModule('emi')">
        <h2>EMI</h2>
    </div>
    <div class="module-card debit-cards" onclick="showModule('debit-cards')">
        <h2>DEBIT CARDS</h2>
    </div>
    <div class="module-card credit-cards" onclick="showModule('credit-cards')">
        <h2>CREDIT CARDS</h2>
    </div>
<div class="module-card investments" onclick="showModule('investments')">
        <h2>INVEST</h2>
    </div>
    <div class="module-card stats" onclick="showModule('stats')">
        <h2>STATS</h2>
    </div>
<div class="module-card documents" onclick="showModule('documents')">
    <h2>IMPORTANT DOCUMENTS</h2>
</div>
</div> 
        </div>

<!-- Floating Calculator -->
<div class="floating-calculator" onclick="openCalculator()">
    🧮
</div>

<div class="calculator-modal" id="calculatorModal" onclick="closeCalculator(event)">
    <div class="calculator-container" onclick="event.stopPropagation()">
        <div class="calculator-header">
            <div class="calculator-title">Calculator</div>
            <button class="calculator-close" onclick="closeCalculator()">×</button>
        </div>
        
        <input type="text" class="calculator-display" id="calcDisplay" readonly>
        
        <div class="calculator-buttons">
            <button class="calc-btn clear" onclick="clearCalc()">C</button>
            <button class="calc-btn clear" onclick="clearEntry()">CE</button>
            <button class="calc-btn operator" onclick="appendToCalc('/')">/</button>
            <button class="calc-btn operator" onclick="appendToCalc('*')">×</button>
            
            <button class="calc-btn number" onclick="appendToCalc('7')">7</button>
            <button class="calc-btn number" onclick="appendToCalc('8')">8</button>
            <button class="calc-btn number" onclick="appendToCalc('9')">9</button>
            <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
            
            <button class="calc-btn number" onclick="appendToCalc('4')">4</button>
            <button class="calc-btn number" onclick="appendToCalc('5')">5</button>
            <button class="calc-btn number" onclick="appendToCalc('6')">6</button>
            <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
            
            <button class="calc-btn number" onclick="appendToCalc('1')">1</button>
            <button class="calc-btn number" onclick="appendToCalc('2')">2</button>
            <button class="calc-btn number" onclick="appendToCalc('3')">3</button>
            <button class="calc-btn equals" onclick="calculateResult()" style="grid-row: span 2;">=</button>
            
            <button class="calc-btn number" onclick="appendToCalc('0')" style="grid-column: span 2;">0</button>
            <button class="calc-btn number" onclick="appendToCalc('.')">.</button>
        </div>
    </div>
</div>

        <!-- Income Module -->
        <div id="income-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #22c55e;">INCOME</h2>
                <button class="add-btn" onclick="showAddForm('income')">+ Add Income</button>
            </div>
            <div id="income-form" class="form-container hidden">
                <div class="form-group">
                    <label>Source</label>
                    <input type="text" id="income-source" placeholder="e.g., Salary, Freelance">
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="income-amount" placeholder="0.00" step="0.01">
                </div>
<div class="form-group">
    <label>Payment Mode</label>
    <select id="income-payment-mode" onchange="handleIncomePaymentModeChange()">
        <option value="">Select Payment Mode</option>
        <option value="cash">Cash</option>
        <option value="debit-card">Debit Card</option>
    </select>
</div>

<div class="form-group hidden" id="income-debit-card-selection">
    <label>Select Debit Card</label>
    <select id="income-debit-card">
        <option value="">Choose Debit Card</option>
    </select>
</div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="income-date">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="income-notes" placeholder="Optional notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveIncome()">Save</button>
                    <button class="btn-secondary" onclick="cancelForm('income')">Cancel</button>
                </div>
            </div>
            <div id="income-list" class="items-list"></div>


        </div>

        <!-- Expense Module -->
        <div id="expense-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #ef4444;">EXPENSE</h2>
                <button class="add-btn" onclick="showAddForm('expense')">+ Add Expense</button>
            </div>
            <div id="expense-form" class="form-container hidden">
                <div class="form-group">
                    <label>Category</label>
                    <select id="expense-category">
                        <option value="">Select Category</option>
                        <option value="food">Food & Dining</option>
                        <option value="transport">Transportation</option>
                        <option value="shopping">Shopping</option>
                        <option value="bills">Bills & Utilities</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expense-description" placeholder="What did you spend on?">
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01">
                </div>
<div class="form-group">
    <label>Payment Mode</label>
    <select id="expense-payment-mode" onchange="handlePaymentModeChange()">
        <option value="">Select Payment Mode</option>
        <option value="cash">Cash</option>
        <option value="debit-card">Debit Card</option>
        <option value="credit-card">Credit Card</option>
        <option value="upi">UPI</option>
    </select>
</div>
<div class="form-group hidden" id="debit-card-selection">
    <label>Select Debit Card</label>
    <select id="expense-debit-card">
        <option value="">Choose Debit Card</option>
    </select>
</div>
<div class="form-group hidden" id="credit-card-selection">
    <label>Select Credit Card</label>
    <select id="expense-credit-card">
        <option value="">Choose Credit Card</option>
    </select>
</div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="expense-date">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="expense-notes" placeholder="Optional notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveExpense()">Save</button>
                    <button class="btn-secondary" onclick="cancelForm('expense')">Cancel</button>
                </div>
            </div>
            <div id="expense-list" class="items-list"></div>
        </div>

        <!-- Lend Module -->
        <div id="lend-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #0ea5e9;">LEND</h2>
                <button class="add-btn" onclick="showAddForm('lend')">+ Add Lending</button>
            </div>
            <div id="lend-form" class="form-container hidden">
    <div class="form-group">
        <label>Lent To</label>
        <input type="text" id="lend-person" placeholder="Person or organization name">
    </div>
    <div class="form-group">
        <label>Amount</label>
        <input type="number" id="lend-amount" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
        <label>Date Lent</label>
        <input type="date" id="lend-date">
    </div>
    <div class="form-group">
        <label>Expected Return Date</label>
        <input type="date" id="lend-return-date">
    </div>
    <div class="form-group">
        <label>Status</label>
        <select id="lend-status" onchange="handleLendStatusChange()">
            <option value="pending">Pending</option>
            <option value="partial">Partially Returned</option>
            <option value="returned">Fully Returned</option>
        </select>
    </div>
    <div class="form-group hidden" id="lend-payment-section">
        <label>Return Amount</label>
        <input type="number" id="lend-payment-amount" placeholder="0.00" step="0.01">
        <label style="margin-top: 10px;">Return Date</label>
        <input type="date" id="lend-payment-date">
    </div>
    <div class="form-group">
        <label>Notes</label>
        <textarea id="lend-notes" placeholder="Optional notes" rows="3"></textarea>
    </div>
    <div class="form-actions">
        <button class="btn-primary" onclick="saveLend()">Save</button>
        <button class="btn-secondary" onclick="cancelForm('lend')">Cancel</button>
    </div>
</div>
            <div id="lend-list" class="items-list"></div>
        </div>

        <!-- Borrow Module -->
        <div id="borrow-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #f59e0b;">BORROW</h2>
                <button class="add-btn" onclick="showAddForm('borrow')">+ Add Borrowing</button>
            </div>
            <div id="borrow-form" class="form-container hidden">
    <div class="form-group">
        <label>Borrowed From</label>
        <input type="text" id="borrow-person" placeholder="Person or organization name">
    </div>
    <div class="form-group">
        <label>Amount</label>
        <input type="number" id="borrow-amount" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
        <label>Date Borrowed</label>
        <input type="date" id="borrow-date">
    </div>
    <div class="form-group">
        <label>Due Date</label>
        <input type="date" id="borrow-due-date">
    </div>
    <div class="form-group">
        <label>Status</label>
        <select id="borrow-status" onchange="handleBorrowStatusChange()">
            <option value="pending">Pending</option>
            <option value="partial">Partially Paid</option>
            <option value="paid">Fully Paid</option>
        </select>
    </div>
    <div class="form-group hidden" id="borrow-payment-section">
        <label>Payment Amount</label>
        <input type="number" id="borrow-payment-amount" placeholder="0.00" step="0.01">
        <label style="margin-top: 10px;">Payment Date</label>
        <input type="date" id="borrow-payment-date">
    </div>
    <div class="form-group">
        <label>Notes</label>
        <textarea id="borrow-notes" placeholder="Optional notes" rows="3"></textarea>
    </div>
    <div class="form-actions">
        <button class="btn-primary" onclick="saveBorrow()">Save</button>
        <button class="btn-secondary" onclick="cancelForm('borrow')">Cancel</button>
    </div>
</div>
            <div id="borrow-list" class="items-list"></div>
        </div>

        <!-- EMI Module -->
        <div id="emi-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #a855f7;">EMI</h2>
                <button class="add-btn" onclick="showAddForm('emi')">+ Add EMI</button>
            </div>
            <div id="emi-form" class="form-container hidden">
                <div class="form-group">
                    <label>EMI Name</label>
                    <input type="text" id="emi-name" placeholder="e.g., Home Loan, Car Loan">
                </div>
                <div class="form-group">
                    <label>Monthly Amount</label>
                    <input type="number" id="emi-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="emi-start-date">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="emi-end-date">
                </div>
                <div class="form-group">
                    <label>Bank/Lender</label>
                    <input type="text" id="emi-bank" placeholder="Bank or lender name">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="emi-status">
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="emi-notes" placeholder="Optional notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveEMI()">Save</button>
                    <button class="btn-secondary" onclick="cancelForm('emi')">Cancel</button>
                </div>
            </div>
            <div id="emi-list" class="items-list"></div>
<!-- EMI Payments Section -->
<div id="emi-payments-section" style="margin-top: 30px;">
    <div class="section-header">
        <h3 style="color: #a855f7; font-size: 20px;">EMI Payments</h3>
        <button class="add-btn" onclick="showEmiPaymentForm()">+ Record EMI Payment</button>
    </div>
    <div id="emi-payment-form" class="form-container hidden">
        <div class="form-group">
            <label>Select EMI</label>
            <select id="emi-select">
                <option value="">Choose EMI</option>
            </select>
        </div>
        <div class="form-group">
            <label>Payment Amount</label>
            <input type="number" id="emi-payment-amount" step="0.01">
        </div>
        <div class="form-group">
            <label>Payment Date</label>
            <input type="date" id="emi-payment-date">
        </div>
        <div class="form-group">
            <label>Payment Mode</label>
            <select id="emi-payment-mode" onchange="handleEmiPaymentModeChange()">
                <option value="">Select Payment Mode</option>
                <option value="debit-card">Debit Card</option>
                <option value="cash">Cash</option>
            </select>
        </div>
        <div class="form-group hidden" id="emi-debit-card-selection">
            <label>Select Debit Card</label>
            <select id="emi-debit-card">
                <option value="">Choose Debit Card</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn-primary" onclick="saveEmiPayment()">Save Payment</button>
            <button class="btn-secondary" onclick="cancelEmiPaymentForm()">Cancel</button>
        </div>
    </div>
    <div id="emi-payments-list" class="items-list"></div>
</div>

        </div>

<!-- Documents Module -->
<div id="documents-detail" class="detail-view">
    <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
    <div class="section-header">
        <h2 class="section-title" style="color: #db2777;">IMPORTANT DOCUMENTS</h2>
        <div style="color: #6b7280; font-size: 14px; margin-top: 10px;">
            Upload up to 6 important documents • Supported formats: PDF, JPG, PNG, JPEG
        </div>
    </div>
    
    <div id="documents-container" style="display: grid; grid-template-columns: 1fr; gap: 15px; padding: 20px 0;">
        <!-- Document cards will be populated here -->
    </div>
</div>

<!-- Investments Module -->
<div id="investments-detail" class="detail-view">
    <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
    <div class="section-header">
        <h2 class="section-title" style="color: #7c3aed;">INVESTMENTS</h2>
        <div style="display: flex; gap: 10px;">
            <button class="add-btn" onclick="showInvestmentForm('stock')">+ Add Stock</button>
            <button class="add-btn" onclick="showInvestmentForm('mutual-fund')">+ Add Mutual Fund</button>
        </div>
    </div>
    
    <!-- Investment Form -->
    <div id="investments-form" class="form-container hidden">
        <div class="form-group">
            <label>Investment Type</label>
            <select id="investment-type" onchange="handleInvestmentTypeChange()" disabled>
                <option value="stock">Stock</option>
                <option value="mutual-fund">Mutual Fund</option>
            </select>
        </div>
        
        <!-- Stock Fields -->
        <div id="stock-fields">
            <div class="form-group">
                <label>Stock Name/Symbol</label>
                <input type="text" id="stock-name" placeholder="e.g., RELIANCE, TCS">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="stock-quantity" placeholder="100" min="1">
            </div>
            <div class="form-group">
                <label>Price per Share</label>
                <input type="number" id="stock-price" placeholder="2500.00" step="0.01">
            </div>
        </div>
        
        <!-- Mutual Fund Fields -->
        <div id="mutual-fund-fields" class="hidden">
            <div class="form-group">
                <label>Fund Name</label>
                <input type="text" id="fund-name" placeholder="e.g., SBI Bluechip Fund">
            </div>
            <div class="form-group">
                <label>Investment Amount</label>
                <input type="number" id="fund-amount" placeholder="5000.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Is SIP?</label>
                <select id="is-sip" onchange="handleSipChange()">
                    <option value="false">One-time Investment</option>
                    <option value="true">Monthly SIP</option>
                </select>
            </div>
            <div id="sip-fields" class="hidden">
                <div class="form-group">
                    <label>SIP Date (Monthly)</label>
                    <input type="number" id="sip-date" placeholder="15" min="1" max="31">
                </div>
                <div class="form-group">
                    <label>SIP Duration (Months)</label>
                    <input type="number" id="sip-duration" placeholder="12" min="1">
                </div>
            </div>
        </div>
        
        <!-- Common Fields -->
        <div class="form-group">
            <label>Payment Mode</label>
            <select id="investment-payment-mode" onchange="handleInvestmentPaymentChange()">
                <option value="">Select Payment Mode</option>
                <option value="debit-card">Debit Card</option>
                <option value="cash">Cash</option>
                <option value="bank-transfer">Bank Transfer</option>
            </select>
        </div>
        <div class="form-group hidden" id="investment-debit-card-selection">
            <label>Select Debit Card</label>
            <select id="investment-debit-card">
                <option value="">Choose Debit Card</option>
            </select>
        </div>
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="investment-date">
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea id="investment-notes" placeholder="Optional notes" rows="3"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn-primary" onclick="saveInvestment()">Save</button>
            <button class="btn-secondary" onclick="cancelInvestmentForm()">Cancel</button>
        </div>
    </div>
    
    <!-- Sell/Withdraw Form -->
    <div id="sell-withdraw-form" class="form-container hidden">
        <h3 id="sell-withdraw-title" style="margin-bottom: 15px;"></h3>
        <div class="form-group">
            <label id="quantity-amount-label">Quantity to Sell</label>
            <input type="number" id="sell-quantity-amount" step="0.01">
        </div>
        <div class="form-group">
            <label>Price/Rate</label>
            <input type="number" id="sell-price-rate" placeholder="Current market price" step="0.01">
        </div>
        <div class="form-group">
            <label>Credit to Bank Account</label>
            <select id="credit-debit-card">
                <option value="">Select Bank Account</option>
            </select>
        </div>
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="sell-date">
        </div>
        <div class="form-actions">
            <button class="btn-primary" onclick="processSellWithdraw()">Confirm</button>
            <button class="btn-secondary" onclick="cancelSellWithdrawForm()">Cancel</button>
        </div>
    </div>
    
    <!-- Investment Lists -->
    <div class="section-header" style="margin-top: 30px;">
        <h3 style="color: #7c3aed; font-size: 20px;">My Stocks</h3>
    </div>
    <div id="stocks-list" class="items-list"></div>
    
    <div class="section-header" style="margin-top: 30px;">
        <h3 style="color: #7c3aed; font-size: 20px;">My Mutual Funds</h3>
    </div>
    <div id="mutual-funds-list" class="items-list"></div>
    
    <!-- SIP Payments Section -->
    <div class="section-header" style="margin-top: 30px;">
        <h3 style="color: #7c3aed; font-size: 20px;">SIP Payments</h3>
        <button class="add-btn" onclick="showSipPaymentForm()">+ Record SIP Payment</button>
    </div>
    <div id="sip-payment-form" class="form-container hidden">
        <div class="form-group">
            <label>Select SIP Fund</label>
            <select id="sip-fund-select">
                <option value="">Choose SIP Fund</option>
            </select>
        </div>
        <div class="form-group">
            <label>Payment Amount</label>
            <input type="number" id="sip-payment-amount" step="0.01">
        </div>
        <div class="form-group">
            <label>Payment Date</label>
            <input type="date" id="sip-payment-date">
        </div>
        <div class="form-group">
            <label>Payment Mode</label>
            <select id="sip-payment-mode" onchange="handleSipPaymentModeChange()">
                <option value="">Select Payment Mode</option>
                <option value="debit-card">Debit Card</option>
                <option value="cash">Cash</option>
            </select>
        </div>
        <div class="form-group hidden" id="sip-debit-card-selection">
            <label>Select Debit Card</label>
            <select id="sip-debit-card">
                <option value="">Choose Debit Card</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn-primary" onclick="saveSipPayment()">Save Payment</button>
            <button class="btn-secondary" onclick="cancelSipPaymentForm()">Cancel</button>
        </div>
    </div>
    <div id="sip-payments-list" class="items-list"></div>
</div>

        <!-- Stats Module -->
        <div id="stats-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #64748b;">STATISTICS</h2>
            </div>
            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated by JavaScript -->
            </div>
            <div id="stats-details">
                <!-- Detailed stats will be populated by JavaScript -->
            </div>
        </div>
        <!-- Debit Cards Module -->
        <div id="debit-cards-detail" class="detail-view">
            <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
            <div class="section-header">
                <h2 class="section-title" style="color: #059669;">DEBIT CARDS</h2>
                <button class="add-btn" onclick="showAddForm('debit-cards')">+ Add Debit Card</button>
            </div>
            <div id="debit-cards-form" class="form-container hidden">
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="debit-bank-name" placeholder="e.g., SBI, HDFC, ICICI">
                </div>
                <div class="form-group">
                    <label>Last 4 Digits</label>
                    <input type="text" id="debit-last-digits" placeholder="1234" maxlength="4">
                </div>
                <div class="form-group">
                    <label>Current Balance</label>
                    <input type="number" id="debit-balance" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label>Card Nickname (Optional)</label>
                    <input type="text" id="debit-nickname" placeholder="e.g., Salary Account">
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveDebitCard()">Save</button>
                    <button class="btn-secondary" onclick="cancelForm('debit-cards')">Cancel</button>
                </div>
            </div>
            <div id="debit-cards-list" class="items-list"></div>
        </div>
<!-- Credit Cards Module -->
<div id="credit-cards-detail" class="detail-view">
    <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
    <div class="section-header">
        <h2 class="section-title" style="color: #ea580c;">CREDIT CARDS</h2>
        <button class="add-btn" onclick="showAddForm('credit-cards')">+ Add Credit Card</button>
    </div>
    <div id="credit-cards-form" class="form-container hidden">
        <div class="form-group">
            <label>Card Name/Bank</label>
            <input type="text" id="credit-card-name" placeholder="e.g., HDFC Regalia, SBI SimplyCLICK">
        </div>
        <div class="form-group">
            <label>Last 4 Digits</label>
            <input type="text" id="credit-last-digits" placeholder="1234" maxlength="4">
        </div>
        <div class="form-group">
            <label>Credit Limit</label>
            <input type="number" id="credit-limit" placeholder="50000" step="0.01">
        </div>
        <div class="form-group">
            <label>Bill Generation Date</label>
            <input type="number" id="credit-bill-date" placeholder="15" min="1" max="31">
        </div>
        <div class="form-group">
            <label>Due Date</label>
            <input type="number" id="credit-due-date" placeholder="5" min="1" max="31">
        </div>
        <div class="form-actions">
            <button class="btn-primary" onclick="saveCreditCard()">Save</button>
            <button class="btn-secondary" onclick="cancelForm('credit-cards')">Cancel</button>
        </div>
    </div>
    <div id="credit-cards-list" class="items-list"></div>
    
    <!-- Monthly Bills Section -->
    <div id="credit-bills-section" style="margin-top: 30px;">
        <div class="section-header">
            <h3 style="color: #ea580c; font-size: 20px;">Monthly Bills</h3>
            <button class="add-btn" onclick="showBillForm()">+ Add Bill</button>
        </div>
        <div id="credit-bill-form" class="form-container hidden">
    <div class="form-group">
        <label>Credit Card</label>
        <select id="bill-credit-card">
            <option value="">Select Credit Card</option>
        </select>
    </div>
    <div class="form-group">
        <label>Bill Amount</label>
        <input type="number" id="bill-amount" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
        <label>Bill Date</label>
        <input type="date" id="bill-date">
    </div>
    <div class="form-group">
        <label>Due Date</label>
        <input type="date" id="bill-due-date">
    </div>
    <div class="form-group">
        <label>Status</label>
        <select id="bill-status" onchange="handleBillStatusChange()">
            <option value="pending">Pending</option>
            <option value="partial">Partially Paid</option>
            <option value="paid">Fully Paid</option>
        </select>
    </div>
    <div class="form-group hidden" id="payment-section">
        <label>Payment Amount</label>
        <input type="number" id="payment-amount" placeholder="0.00" step="0.01">
        <label style="margin-top: 10px;">Payment Date</label>
        <input type="date" id="payment-date">
    </div>
    <div class="form-actions">
        <button class="btn-primary" onclick="saveCreditBill()">Save Bill</button>
        <button class="btn-secondary" onclick="cancelBillForm()">Cancel</button>
    </div>

    </div>
<div id="credit-bills-list" class="items-list"></div>
</div>

    <script>
        // Global variables
        let currentEditId = null;
        let currentEditType = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for all date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
            
            loadAllData();
            initializeCalculatorDrag();
            loadCalculatorPosition();

            // Add event listener for bill amount changes
    document.getElementById('bill-amount').addEventListener('input', function() {
        const status = document.getElementById('bill-status').value;
        const paymentAmount = document.getElementById('payment-amount');
        const billAmount = parseFloat(this.value) || 0;
        
        // If status is "Fully Paid", update payment amount when bill amount changes
        if (status === 'paid' && billAmount > 0) {
            paymentAmount.value = billAmount.toFixed(2);
        }
    });
        });

        // Navigation functions
        function showDashboard() {
            document.querySelectorAll('.detail-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById('dashboard').style.display = 'block';
        }

        function showModule(module) {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById(module + '-detail').classList.add('active');
            loadModuleData(module);
        }

        function showAddForm(type) {
    document.getElementById(type + '-form').classList.remove('hidden');
    // Only clear edit variables if we're not editing
    if (currentEditType !== type) {
        currentEditId = null;
        currentEditType = null;
    }
}

        function cancelForm(type) {
    document.getElementById(type + '-form').classList.add('hidden');
    clearForm(type);
    currentEditId = null;
    currentEditType = null;
}

        function clearForm(type) {
    const form = document.getElementById(type + '-form');
    if (form) {
        const inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type === 'date') {
                input.value = new Date().toISOString().split('T')[0];
            } else {
                input.value = '';
            }
        });
    }
}

        // Local Storage functions
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Income functions
function saveIncome() {
    const source = document.getElementById('income-source').value.trim();
    const amount = parseFloat(document.getElementById('income-amount').value);
    const date = document.getElementById('income-date').value;
    const notes = document.getElementById('income-notes').value.trim();
    const paymentMode = document.getElementById('income-payment-mode').value;
    const debitCardId = document.getElementById('income-debit-card')?.value || null;

    if (!source || !amount || !date || !paymentMode) {
        alert('Please fill in all required fields');
        return;
    }

    const incomes = loadFromStorage('incomes');
    const income = {
        id: currentEditId || generateId(),
        source,
        amount,
        paymentMode,
        debitCardId,
        date,
        notes,
        createdAt: currentEditId ? incomes.find(i => i.id === currentEditId).createdAt : new Date().toISOString()
    };

    if (currentEditId) {
        const index = incomes.findIndex(i => i.id === currentEditId);
        incomes[index] = income;
    } else {
        incomes.push(income);
    }

    saveToStorage('incomes', incomes);

    // Update moneyIn (new or update existing)
    let moneyIn = loadFromStorage('moneyIn');
    const existingIndex = moneyIn.findIndex(m => m.linkedIncomeId === income.id);

    if (existingIndex !== -1) {
        moneyIn[existingIndex] = {
            ...moneyIn[existingIndex],
            description: `Income: ${source}`,
            amount,
            paymentMode,
            debitCardId,
            date,
            notes
        };
    } else {
        moneyIn.push({
            id: generateId(),
            linkedIncomeId: income.id,
            type: 'income',
            description: `Income: ${source}`,
            amount,
            paymentMode,
            debitCardId,
            date,
            notes,
            createdAt: income.createdAt
        });
    }
    saveToStorage('moneyIn', moneyIn);

    // Adjust debit card balance only if income credited to card
    if (paymentMode === 'debit-card' && debitCardId) {
        updateDebitCardBalance(debitCardId, amount, false); // add to balance
    }

    cancelForm('income');
    loadModuleData('income');
}


        function deleteIncome(id) {
    if (confirm('Are you sure you want to delete this income?')) {
        const incomes = loadFromStorage('incomes');
        const incomeToDelete = incomes.find(i => i.id === id);

        if (incomeToDelete) {
            // Remove linked moneyIn
            let moneyIn = loadFromStorage('moneyIn');
            moneyIn = moneyIn.filter(m => m.linkedIncomeId !== id);
            saveToStorage('moneyIn', moneyIn);

            // Reverse debit card balance if credited earlier
            if (incomeToDelete.debitCardId) {
                updateDebitCardBalance(incomeToDelete.debitCardId, incomeToDelete.amount, true); // deduct back
            }
        }

        const filtered = incomes.filter(income => income.id !== id);
        saveToStorage('incomes', filtered);
        loadModuleData('income');
    }
}


        function editIncome(id) {
            const incomes = loadFromStorage('incomes');
            const income = incomes.find(i => i.id === id);
            
            if (income) {
                document.getElementById('income-source').value = income.source;
                document.getElementById('income-amount').value = income.amount;
                document.getElementById('income-date').value = income.date;
                document.getElementById('income-notes').value = income.notes;
                
                currentEditId = id;
                currentEditType = 'income';
                showAddForm('income');
            }
        }

        // Expense functions
        function saveExpense() {
    const category = document.getElementById('expense-category').value;
    const description = document.getElementById('expense-description').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const paymentMode = document.getElementById('expense-payment-mode').value;
    const date = document.getElementById('expense-date').value;
    const notes = document.getElementById('expense-notes').value.trim();

    if (!category || !description || !amount || !paymentMode || !date) {
        alert('Please fill in all required fields');
        return;
    }

    let debitCardId = null;
    let creditCard = null;

    // Validate payment mode specific fields
    if (paymentMode === 'debit-card' || paymentMode === 'upi') {
        debitCardId = document.getElementById('expense-debit-card').value;
        if (!debitCardId) {
            alert('Please select a debit card');
            return;
        }
    } else if (paymentMode === 'credit-card') {
    const creditCardId = document.getElementById('expense-credit-card').value;
    if (!creditCardId) {
        alert('Please select a credit card');
        return;
    }
    // Get credit card details for display
    const creditCards = loadFromStorage('creditCards');
    const selectedCard = creditCards.find(c => c.id === creditCardId);
    creditCard = selectedCard ? `${selectedCard.cardName} - *${selectedCard.lastDigits}` : creditCardId;
}

    const expenses = loadFromStorage('expenses');
    const expense = {
        id: currentEditId || generateId(),
        category,
        description,
        amount,
        paymentMode,
        debitCardId,
        creditCard,
creditCardId: paymentMode === 'credit-card' ? document.getElementById('expense-credit-card').value : null,
        date,
        notes,
        createdAt: currentEditId ? expenses.find(e => e.id === currentEditId).createdAt : new Date().toISOString()
    };

    if (currentEditId) {
        // Handle editing - need to reverse previous debit card transaction
        const oldExpense = expenses.find(e => e.id === currentEditId);
        if (oldExpense && oldExpense.debitCardId && (oldExpense.paymentMode === 'debit-card' || oldExpense.paymentMode === 'upi')) {
            updateDebitCardBalance(oldExpense.debitCardId, oldExpense.amount, false); // Add back
        }
        
        const index = expenses.findIndex(e => e.id === currentEditId);
        expenses[index] = expense;
    } else {
        expenses.push(expense);
    }

    // Update debit card balance if applicable (not for credit cards)
if (debitCardId && (paymentMode === 'debit-card' || paymentMode === 'upi')) {
    updateDebitCardBalance(debitCardId, amount, true); // Deduct
}

// Add or update moneyOut only if NOT credit card
if (paymentMode !== 'credit-card') {
    let moneyOut = loadFromStorage('moneyOut');

    const existingOutIndex = moneyOut.findIndex(m => m.linkedExpenseId === expense.id);

    if (existingOutIndex !== -1) {
        // Update existing entry
        moneyOut[existingOutIndex] = {
            ...moneyOut[existingOutIndex],
            description: `Expense: ${description}`,
            amount,
            category,
            paymentMode,
            debitCardId,
            date,
            notes
        };
    } else {
        // New entry
        moneyOut.push({
            id: generateId(),
            linkedExpenseId: expense.id,
            type: 'expense',
            description: `Expense: ${description}`,
            amount,
            category,
            paymentMode,
            debitCardId,
            date,
            notes,
            createdAt: new Date().toISOString()
        });
    }

    saveToStorage('moneyOut', moneyOut);
}



    saveToStorage('expenses', expenses);
    cancelForm('expense');
    loadModuleData('expense');
}

        function deleteExpense(id) {
    if (confirm('Are you sure you want to delete this expense?')) {
        const expenses = loadFromStorage('expenses');
        const expenseToDelete = expenses.find(e => e.id === id);

        if (expenseToDelete) {
            // Remove linked moneyOut entry
            if (expenseToDelete.paymentMode !== 'credit-card') {
                let moneyOut = loadFromStorage('moneyOut');
                moneyOut = moneyOut.filter(m => m.linkedExpenseId !== id);
                saveToStorage('moneyOut', moneyOut);

                // Restore debit card balance if debit/upi
                if (expenseToDelete.debitCardId && 
                   (expenseToDelete.paymentMode === 'debit-card' || expenseToDelete.paymentMode === 'upi')) {
                    console.log("Restoring balance for card:", expenseToDelete.debitCardId, " amount:", expenseToDelete.amount);
                    updateDebitCardBalance(expenseToDelete.debitCardId, expenseToDelete.amount, false); // add back
                }
            }
        }

        const filtered = expenses.filter(expense => expense.id !== id);
        saveToStorage('expenses', filtered);
        loadModuleData('expense');
    }
}



        function editExpense(id) {
    const expenses = loadFromStorage('expenses');
    const expense = expenses.find(e => e.id === id);
    
    if (expense) {
        document.getElementById('expense-category').value = expense.category;
        document.getElementById('expense-description').value = expense.description;
        document.getElementById('expense-amount').value = expense.amount;
        document.getElementById('expense-payment-mode').value = expense.paymentMode || '';
        document.getElementById('expense-date').value = expense.date;
        document.getElementById('expense-notes').value = expense.notes;
        
        // Handle payment mode specific fields
        handlePaymentModeChange();
        
        if (expense.debitCardId) {
            document.getElementById('expense-debit-card').value = expense.debitCardId;
        }
        if (expense.creditCardId) {
    document.getElementById('expense-credit-card').value = expense.creditCardId;
}
        
        currentEditId = id;
        currentEditType = 'expense';
        showAddForm('expense');
    }
}

        // Lend functions
        // Enhanced Lend functions
function saveLend() {
    const person = document.getElementById('lend-person').value.trim();
    const amount = parseFloat(document.getElementById('lend-amount').value);
    const date = document.getElementById('lend-date').value;
    const returnDate = document.getElementById('lend-return-date').value;
    const status = document.getElementById('lend-status').value;
    const notes = document.getElementById('lend-notes').value.trim();
    const paymentAmount = parseFloat(document.getElementById('lend-payment-amount').value) || 0;
    const paymentDate = document.getElementById('lend-payment-date').value;

    if (!person || !amount || !date) {
        alert('Please fill in all required fields');
        return;
    }

    const lends = loadFromStorage('lends');
    const editId = currentEditId;
    
    let paymentLogs = [];
    let totalReturned = 0;

    if (editId) {
        // Keep existing payment logs for edited entries
        const existingLend = lends.find(l => l.id === editId);
        paymentLogs = existingLend.paymentLogs || [];
        totalReturned = paymentLogs.reduce((sum, log) => sum + log.amount, 0);
        
        // Only add new payment if it's different from existing
        if (paymentAmount > 0 && paymentDate) {
            const remainingAmount = amount - totalReturned;
            
            // Only record payment if there's actually a payment to record
            if (paymentAmount > 0 && paymentAmount <= remainingAmount) {
                paymentLogs.push({
                    id: generateId(),
                    amount: paymentAmount,
                    date: paymentDate,
                    timestamp: new Date().toISOString()
                });
                totalReturned += paymentAmount;
            }
        }
    } else {
        // For new lends, add payment if provided
        if (paymentAmount > 0 && paymentDate) {
            paymentLogs.push({
                id: generateId(),
                amount: paymentAmount,
                date: paymentDate,
                timestamp: new Date().toISOString()
            });
            totalReturned = paymentAmount;
        }
    }

    // Update status based on actual returns
    let finalStatus = status;
    if (totalReturned >= amount) {
        finalStatus = 'returned';
    } else if (totalReturned > 0) {
        finalStatus = 'partial';
    } else {
        finalStatus = 'pending';
    }

    const lend = {
        id: editId || generateId(),
        person,
        amount,
        date,
        returnDate,
        status: finalStatus,
        notes,
        totalReturned,
        paymentLogs,
        createdAt: editId ? lends.find(l => l.id === editId).createdAt : new Date().toISOString()
    };

    if (editId) {
        const index = lends.findIndex(l => l.id === editId);
        lends[index] = lend;
    } else {
        lends.push(lend);
        
        // Add lending amount to money out (only for new lending)
        const moneyOut = loadFromStorage('moneyOut');
        moneyOut.push({
            id: generateId(),
            type: 'lending',
            description: `Lent to: ${person}`,
            amount,
            date,
            notes: `Lending transaction - ${notes}`,
            createdAt: new Date().toISOString()
        });
        saveToStorage('moneyOut', moneyOut);
    }

    // Add return amount to money in (if new payment received)
    if (paymentAmount > 0 && paymentDate && (!editId || paymentAmount > 0)) {
        const moneyIn = loadFromStorage('moneyIn');
        moneyIn.push({
            id: generateId(),
            type: 'lending_recovery',
            description: `Return from: ${person}`,
            amount: paymentAmount,
            date: paymentDate,
            notes: `Lending recovery - ${notes}`,
            createdAt: new Date().toISOString()
        });
        saveToStorage('moneyIn', moneyIn);
    }

    saveToStorage('lends', lends);
    cancelForm('lend');
    loadModuleData('lend');
}

function editLend(id) {
    const lends = loadFromStorage('lends');
    const lend = lends.find(l => l.id === id);
    
    if (lend) {
        document.getElementById('lend-person').value = lend.person;
        document.getElementById('lend-amount').value = lend.amount;
        document.getElementById('lend-date').value = lend.date;
        document.getElementById('lend-return-date').value = lend.returnDate;
        document.getElementById('lend-status').value = lend.status;
        document.getElementById('lend-notes').value = lend.notes;
        
        // Handle payment section visibility
        handleLendStatusChange();
        
        // Clear payment fields for editing
        document.getElementById('lend-payment-amount').value = '';
        document.getElementById('lend-payment-date').value = '';
        
        currentEditId = id;
        currentEditType = 'lend';
        showAddForm('lend');
    }
}

// Add payment function for lending
function addLendPayment(lendId) {
    const lends = loadFromStorage('lends');
    const lend = lends.find(l => l.id === lendId);
    
    if (!lend) return;
    
    const remainingAmount = lend.amount - (lend.totalReturned || 0);
    const paymentAmount = prompt(`Outstanding amount: ₹${remainingAmount.toFixed(2)}\nEnter return amount:`);
    
    if (paymentAmount && !isNaN(paymentAmount) && parseFloat(paymentAmount) > 0) {
        const amount = parseFloat(paymentAmount);
        const today = new Date().toISOString().split('T')[0];
        
        if (!lend.paymentLogs) lend.paymentLogs = [];
        
        lend.paymentLogs.push({
            id: generateId(),
            amount: amount,
            date: today,
            timestamp: new Date().toISOString()
        });
        
        lend.totalReturned = (lend.totalReturned || 0) + amount;
        
        // Update status if fully returned
        if (lend.totalReturned >= lend.amount) {
            lend.status = 'returned';
        }
        
        saveToStorage('lends', lends);
        displayLends();
    }
}

        function deleteLend(id) {
            if (confirm('Are you sure you want to delete this lending record?')) {
                const lends = loadFromStorage('lends');
                const filtered = lends.filter(lend => lend.id !== id);
                saveToStorage('lends', filtered);
                loadModuleData('lend');
            }
        }

        function editLend(id) {
            const lends = loadFromStorage('lends');
            const lend = lends.find(l => l.id === id);
            
            if (lend) {
                document.getElementById('lend-person').value = lend.person;
                document.getElementById('lend-amount').value = lend.amount;
                document.getElementById('lend-date').value = lend.date;
                document.getElementById('lend-return-date').value = lend.returnDate;
                document.getElementById('lend-status').value = lend.status;
                document.getElementById('lend-notes').value = lend.notes;
                
                currentEditId = id;
                currentEditType = 'lend';
                showAddForm('lend');
            }
        }

        // Borrow functions
        // Enhanced Borrow functions
function saveBorrow() {
    const person = document.getElementById('borrow-person').value.trim();
    const amount = parseFloat(document.getElementById('borrow-amount').value);
    const date = document.getElementById('borrow-date').value;
    const dueDate = document.getElementById('borrow-due-date').value;
    const status = document.getElementById('borrow-status').value;
    const notes = document.getElementById('borrow-notes').value.trim();
    const paymentAmount = parseFloat(document.getElementById('borrow-payment-amount').value) || 0;
    const paymentDate = document.getElementById('borrow-payment-date').value;

    if (!person || !amount || !date) {
        alert('Please fill in all required fields');
        return;
    }

    const borrows = loadFromStorage('borrows');
    const editId = currentEditId;
    
    let paymentLogs = [];
    let totalPaid = 0;

    if (editId) {
        // Keep existing payment logs for edited entries
        const existingBorrow = borrows.find(b => b.id === editId);
        paymentLogs = existingBorrow.paymentLogs || [];
        totalPaid = paymentLogs.reduce((sum, log) => sum + log.amount, 0);
        
        // Only add new payment if it's different from existing
        if (paymentAmount > 0 && paymentDate) {
            const remainingAmount = amount - totalPaid;
            
            // Only record payment if there's actually a payment to record
            if (paymentAmount > 0 && paymentAmount <= remainingAmount) {
                paymentLogs.push({
                    id: generateId(),
                    amount: paymentAmount,
                    date: paymentDate,
                    timestamp: new Date().toISOString()
                });
                totalPaid += paymentAmount;
            }
        }
    } else {
        // For new borrows, add payment if provided
        if (paymentAmount > 0 && paymentDate) {
            paymentLogs.push({
                id: generateId(),
                amount: paymentAmount,
                date: paymentDate,
                timestamp: new Date().toISOString()
            });
            totalPaid = paymentAmount;
        }
    }

    // Update status based on actual payments
    let finalStatus = status;
    if (totalPaid >= amount) {
        finalStatus = 'paid';
    } else if (totalPaid > 0) {
        finalStatus = 'partial';
    } else {
        finalStatus = 'pending';
    }

    const borrow = {
        id: editId || generateId(),
        person,
        amount,
        date,
        dueDate,
        status: finalStatus,
        notes,
        totalPaid,
        paymentLogs,
        createdAt: editId ? borrows.find(b => b.id === editId).createdAt : new Date().toISOString()
    };

    if (editId) {
        const index = borrows.findIndex(b => b.id === editId);
        borrows[index] = borrow;
    } else {
        borrows.push(borrow);
        
        // Add borrowed amount to money in (only for new borrowing)
        const moneyIn = loadFromStorage('moneyIn');
        moneyIn.push({
            id: generateId(),
            type: 'borrowed_amount',
            description: `Borrowed from: ${person}`,
            amount,
            date,
            notes: `Borrowing transaction - ${notes}`,
            createdAt: new Date().toISOString()
        });
        saveToStorage('moneyIn', moneyIn);
    }

    // Add payment to money out (if new payment made)
    if (paymentAmount > 0 && paymentDate && (!editId || paymentAmount > 0)) {
        const moneyOut = loadFromStorage('moneyOut');
        moneyOut.push({
            id: generateId(),
            type: 'borrowed_amount_return',
            description: `Payment to: ${person}`,
            amount: paymentAmount,
            date: paymentDate,
            notes: `Borrowing repayment - ${notes}`,
            createdAt: new Date().toISOString()
        });
        saveToStorage('moneyOut', moneyOut);
    }

    saveToStorage('borrows', borrows);
    cancelForm('borrow');
    loadModuleData('borrow');
}

function editBorrow(id) {
    const borrows = loadFromStorage('borrows');
    const borrow = borrows.find(b => b.id === id);
    
    if (borrow) {
        document.getElementById('borrow-person').value = borrow.person;
        document.getElementById('borrow-amount').value = borrow.amount;
        document.getElementById('borrow-date').value = borrow.date;
        document.getElementById('borrow-due-date').value = borrow.dueDate;
        document.getElementById('borrow-status').value = borrow.status;
        document.getElementById('borrow-notes').value = borrow.notes;
        
        // Handle payment section visibility
        handleBorrowStatusChange();
        
        // Clear payment fields for editing
        document.getElementById('borrow-payment-amount').value = '';
        document.getElementById('borrow-payment-date').value = '';
        
        currentEditId = id;
        currentEditType = 'borrow';
        showAddForm('borrow');
    }
}

// Add payment function for borrowing
function addBorrowPayment(borrowId) {
    const borrows = loadFromStorage('borrows');
    const borrow = borrows.find(b => b.id === borrowId);
    
    if (!borrow) return;
    
    const remainingAmount = borrow.amount - (borrow.totalPaid || 0);
    const paymentAmount = prompt(`Outstanding amount: ₹${remainingAmount.toFixed(2)}\nEnter payment amount:`);
    
    if (paymentAmount && !isNaN(paymentAmount) && parseFloat(paymentAmount) > 0) {
        const amount = parseFloat(paymentAmount);
        const today = new Date().toISOString().split('T')[0];
        
        if (!borrow.paymentLogs) borrow.paymentLogs = [];
        
        borrow.paymentLogs.push({
            id: generateId(),
            amount: amount,
            date: today,
            timestamp: new Date().toISOString()
        });
        
        borrow.totalPaid = (borrow.totalPaid || 0) + amount;
        
        // Update status if fully paid
        if (borrow.totalPaid >= borrow.amount) {
            borrow.status = 'paid';
        }
        
        saveToStorage('borrows', borrow);
        displayBorrows();
    }
}

        function deleteBorrow(id) {
            if (confirm('Are you sure you want to delete this borrowing record?')) {
                const borrows = loadFromStorage('borrows');
                const filtered = borrows.filter(borrow => borrow.id !== id);
                saveToStorage('borrows', filtered);
                loadModuleData('borrow');
            }
        }

        function editBorrow(id) {
            const borrows = loadFromStorage('borrows');
            const borrow = borrows.find(b => b.id === id);
            
            if (borrow) {
                document.getElementById('borrow-person').value = borrow.person;
                document.getElementById('borrow-amount').value = borrow.amount;
                document.getElementById('borrow-date').value = borrow.date;
                document.getElementById('borrow-due-date').value = borrow.dueDate;
                document.getElementById('borrow-status').value = borrow.status;
                document.getElementById('borrow-notes').value = borrow.notes;
                
                currentEditId = id;
                currentEditType = 'borrow';
                showAddForm('borrow');
            }
        }

        // EMI functions
        function saveEMI() {
            const name = document.getElementById('emi-name').value.trim();
            const amount = parseFloat(document.getElementById('emi-amount').value);
            const startDate = document.getElementById('emi-start-date').value;
            const endDate = document.getElementById('emi-end-date').value;
            const bank = document.getElementById('emi-bank').value.trim();
            const status = document.getElementById('emi-status').value;
            const notes = document.getElementById('emi-notes').value.trim();

            if (!name || !amount || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }

            const emis = loadFromStorage('emis');
            const emi = {
                id: currentEditId || generateId(),
                name,
                amount,
                startDate,
                endDate,
                bank,
                status,
                notes,
                createdAt: currentEditId ? emis.find(e => e.id === currentEditId).createdAt : new Date().toISOString()
            };

            if (currentEditId) {
                const index = emis.findIndex(e => e.id === currentEditId);
                emis[index] = emi;
            } else {
                emis.push(emi);
            }

            saveToStorage('emis', emis);
            cancelForm('emi');
            loadModuleData('emi');
        }

        function deleteEMI(id) {
            if (confirm('Are you sure you want to delete this EMI record?')) {
                const emis = loadFromStorage('emis');
                const filtered = emis.filter(emi => emi.id !== id);
                saveToStorage('emis', filtered);
                loadModuleData('emi');
            }
        }

        function editEMI(id) {
            const emis = loadFromStorage('emis');
            const emi = emis.find(e => e.id === id);
            
            if (emi) {
                document.getElementById('emi-name').value = emi.name;
                document.getElementById('emi-amount').value = emi.amount;
                document.getElementById('emi-start-date').value = emi.startDate;
                document.getElementById('emi-end-date').value = emi.endDate;
                document.getElementById('emi-bank').value = emi.bank;
                document.getElementById('emi-status').value = emi.status;
                document.getElementById('emi-notes').value = emi.notes;
                
                currentEditId = id;
                currentEditType = 'emi';
                showAddForm('emi');
            }
        }

function displayEmiPayments() {
    const moneyOut = loadFromStorage('moneyOut');
    const emiPayments = moneyOut.filter(item => item.type === 'emi_payment');
    const container = document.getElementById('emi-payments-list');
    
    if (emiPayments.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No EMI payments recorded yet.</div>';
        return;
    }

    container.innerHTML = emiPayments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(payment => {
        const emis = loadFromStorage('emis');
        const emi = emis.find(e => e.name === payment.description.replace('EMI Payment: ', ''));
        const emiName = emi ? emi.name : payment.description;
        
        const debitCards = loadFromStorage('debitCards');
        const card = debitCards.find(c => c.id === payment.debitCardId);
        const paymentInfo = card ? ` • ${payment.paymentMode.toUpperCase()}: ${card.bankName} *${card.lastDigits}` : ` • ${payment.paymentMode.toUpperCase()}`;
        
        return `
            <div class="item-card emi">
                <div class="item-header">
                    <div class="item-title">${emiName}</div>
                    <div class="item-amount">-₹${payment.amount.toFixed(2)}</div>
                </div>
                <div class="item-details">${formatDate(payment.date)}${paymentInfo}</div>
                ${payment.notes ? `<div class="item-details">${payment.notes}</div>` : ''}
            </div>
        `;
    }).join('');
}

function handleEmiPaymentStatusChange() {
    const status = document.getElementById('emi-payment-status').value;
    const paymentSection = document.getElementById('emi-payment-section');
    const paymentAmount = document.getElementById('emi-payment-amount');
    const emiAmount = parseFloat(document.getElementById('emi-amount').value) || 0;
    
    // Get existing payment logs if editing
    const editId = document.getElementById('emi-payment-form').getAttribute('data-edit-id');
    let existingTotalPaid = 0;
    
    if (editId) {
        const emiPayments = loadFromStorage('emiPayments');
        const existingPayment = emiPayments.find(p => p.id === editId);
        if (existingPayment) {
            existingTotalPaid = existingPayment.amount || 0;
        }
    }
    
    const remainingAmount = emiAmount - existingTotalPaid;
    
    if (status === 'paid') {
        paymentSection.classList.remove('hidden');
        
        // Auto-fill payment amount for "Paid" status
        if (emiAmount > 0) {
            // Only fill the remaining amount if editing
            paymentAmount.value = remainingAmount > 0 ? remainingAmount.toFixed(2) : emiAmount.toFixed(2);
        }
        
        // Set today as default payment date
        const paymentDate = document.getElementById('emi-payment-date');
        if (!paymentDate.value) {
            paymentDate.value = new Date().toISOString().split('T')[0];
        }
    } else {
        paymentSection.classList.add('hidden');
    }
}

// Investment Functions
let currentSellWithdrawId = null;
let currentSellWithdrawType = null;

function showInvestmentForm(type) {
    document.getElementById('investments-form').classList.remove('hidden');
    document.getElementById('investment-type').value = type;
    handleInvestmentTypeChange();
    populateInvestmentDebitCards();
    
    // Set today's date
    document.getElementById('investment-date').value = new Date().toISOString().split('T')[0];
}

function handleInvestmentTypeChange() {
    const type = document.getElementById('investment-type').value;
    const stockFields = document.getElementById('stock-fields');
    const mutualFundFields = document.getElementById('mutual-fund-fields');
    
    if (type === 'stock') {
        stockFields.classList.remove('hidden');
        mutualFundFields.classList.add('hidden');
    } else {
        stockFields.classList.add('hidden');
        mutualFundFields.classList.remove('hidden');
    }
}

function handleSipChange() {
    const isSip = document.getElementById('is-sip').value === 'true';
    const sipFields = document.getElementById('sip-fields');
    
    if (isSip) {
        sipFields.classList.remove('hidden');
    } else {
        sipFields.classList.add('hidden');
    }
}

function handleInvestmentPaymentChange() {
    const paymentMode = document.getElementById('investment-payment-mode').value;
    const debitCardSection = document.getElementById('investment-debit-card-selection');
    
    if (paymentMode === 'debit-card') {
        debitCardSection.classList.remove('hidden');
    } else {
        debitCardSection.classList.add('hidden');
    }
}

function populateInvestmentDebitCards() {
    const debitCards = loadFromStorage('debitCards');
    const selects = ['investment-debit-card', 'credit-debit-card', 'sip-debit-card'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = selectId === 'credit-debit-card' ? 
                '<option value="">Select Bank Account</option>' : 
                '<option value="">Choose Debit Card</option>';
            
            debitCards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.id;
                option.textContent = `${card.bankName} - *${card.lastDigits}${card.nickname ? ' (' + card.nickname + ')' : ''}`;
                select.appendChild(option);
            });
        }
    });
}

function saveInvestment() {
    const type = document.getElementById('investment-type').value;
    const paymentMode = document.getElementById('investment-payment-mode').value;
    const debitCardId = document.getElementById('investment-debit-card').value;
    const date = document.getElementById('investment-date').value;
    const notes = document.getElementById('investment-notes').value.trim();
    const existingStockId = document.getElementById('investments-form').getAttribute('data-existing-stock-id');
    
    if (!paymentMode || !date) {
        alert('Please fill in all required fields');
        return;
    }
    
    let investment = {
        id: generateId(),
        type,
        paymentMode,
        debitCardId,
        date,
        notes,
        createdAt: new Date().toISOString()
    };
    
    if (type === 'stock') {
        const stockName = document.getElementById('stock-name').value.trim();
        const quantity = parseInt(document.getElementById('stock-quantity').value);
        const price = parseFloat(document.getElementById('stock-price').value);
        
        if (!stockName || !quantity || !price) {
            alert('Please fill in all stock details');
            return;
        }
        
        investment = {
            ...investment,
            stockName: stockName.toUpperCase(),
            quantity,
            price,
            totalAmount: quantity * price,
            currentQuantity: quantity
        };
        
        const stocks = loadFromStorage('stocks');
        let existingStockIndex = -1;
        
        if (existingStockId) {
            // Buying more of existing stock
            existingStockIndex = stocks.findIndex(s => s.id === existingStockId);
        } else {
            // Check if stock already exists by name
            existingStockIndex = stocks.findIndex(s => s.stockName === investment.stockName);
        }
        
        if (existingStockIndex !== -1) {
            // Add to existing stock's purchase history
            if (!stocks[existingStockIndex].purchaseHistory) {
                stocks[existingStockIndex].purchaseHistory = [];
            }
            stocks[existingStockIndex].purchaseHistory.push({
                id: investment.id,
                quantity,
                price,
                totalAmount: investment.totalAmount,
                date,
                paymentMode,
                debitCardId,
                notes
            });
            stocks[existingStockIndex].currentQuantity += quantity;
        } else {
            // Create new stock entry
            investment.purchaseHistory = [{
                id: investment.id,
                quantity,
                price,
                totalAmount: investment.totalAmount,
                date,
                paymentMode,
                debitCardId,
                notes
            }];
            stocks.push(investment);
        }
        
        saveToStorage('stocks', stocks);
        
    } else {
        // Mutual Fund code remains the same...
        const fundName = document.getElementById('fund-name').value.trim();
        const amount = parseFloat(document.getElementById('fund-amount').value);
        const isSip = document.getElementById('is-sip').value === 'true';
        
        if (!fundName || !amount) {
            alert('Please fill in all mutual fund details');
            return;
        }
        
        investment = {
            ...investment,
            fundName,
            amount,
            isSip,
            totalInvested: amount
        };
        
        if (isSip) {
            const sipDate = parseInt(document.getElementById('sip-date').value);
            const sipDuration = parseInt(document.getElementById('sip-duration').value);
            
            if (!sipDate || !sipDuration) {
                alert('Please fill in SIP details');
                return;
            }
            
            investment.sipDate = sipDate;
            investment.sipDuration = sipDuration;
            investment.sipPayments = [{
                id: generateId(),
                amount,
                date,
                paymentMode,
                debitCardId,
                status: 'paid'
            }];
        }
        
        const mutualFunds = loadFromStorage('mutualFunds');
        mutualFunds.push(investment);
        saveToStorage('mutualFunds', mutualFunds);
    }
    
   // Update bank balance if debit card used
if (paymentMode === 'debit-card' && debitCardId) {
    const totalAmount = type === 'stock' ? investment.totalAmount : investment.amount;
    updateDebitCardBalance(debitCardId, totalAmount, true);
}

// Record as money out instead of expense
const moneyOut = loadFromStorage('moneyOut');
const totalAmount = type === 'stock' ? investment.totalAmount : investment.amount;
moneyOut.push({
    id: generateId(),
    type: type === 'stock' ? 'stock_purchase' : 'mutual_fund_purchase',
    description: type === 'stock' ? `Stock Purchase: ${investment.stockName} - ${investment.quantity} shares` : `Mutual Fund Investment: ${investment.fundName}`,
    amount: totalAmount,
    date,
    paymentMode,
    debitCardId,
    notes: `Investment transaction - ${notes}`,
    createdAt: new Date().toISOString()
});
saveToStorage('moneyOut', moneyOut);
    
    cancelInvestmentForm();
    loadModuleData('investments');
}

function cancelInvestmentForm() {
    document.getElementById('investments-form').classList.add('hidden');
    // Add this line:
    document.getElementById('investments-form').removeAttribute('data-existing-stock-id');
    clearInvestmentForm();
}

function clearInvestmentForm() {
    const form = document.getElementById('investments-form');
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        if (input.type === 'date') {
            input.value = new Date().toISOString().split('T')[0];
        } else if (input.id === 'investment-type') {
            // Don't clear this as it's set by button click
        } else {
            input.value = '';
        }
        
        // Add this block:
        // Reset readonly state and styling for stock name field
        if (input.id === 'stock-name') {
            input.readOnly = false;
            input.style.backgroundColor = '';
        }
    });
    
    // Reset visibility
    document.getElementById('stock-fields').classList.remove('hidden');
    document.getElementById('mutual-fund-fields').classList.add('hidden');
    document.getElementById('sip-fields').classList.add('hidden');
    document.getElementById('investment-debit-card-selection').classList.add('hidden');
}

// Display Functions
function displayStocks() {
    const stocks = loadFromStorage('stocks');
    const container = document.getElementById('stocks-list');
    
    if (stocks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No stocks purchased yet. Buy your first stock!</div>';
        return;
    }

    container.innerHTML = stocks.map(stock => {
        const totalInvested = stock.purchaseHistory.reduce((sum, purchase) => sum + purchase.totalAmount, 0);
        const totalSold = stock.saleHistory ? stock.saleHistory.reduce((sum, sale) => sum + sale.totalAmount, 0) : 0;
        const totalQuantitySold = stock.saleHistory ? stock.saleHistory.reduce((sum, sale) => sum + sale.quantity, 0) : 0;
        
        // Calculate average price based on remaining quantity
        const avgPrice = stock.currentQuantity > 0 ? totalInvested / (stock.currentQuantity + totalQuantitySold) : 0;
        const currentValue = stock.currentQuantity * avgPrice;
        
        const purchaseHistoryId = `purchase-history-${stock.id}`;
const purchaseHistoryHtml = `
    <div class="history-content" id="${purchaseHistoryId}">
        ${stock.purchaseHistory.map(purchase => `
            <div class="history-item">
                • ${purchase.quantity} shares @ ₹${purchase.price.toFixed(2)} = ₹${purchase.totalAmount.toFixed(2)} on ${formatDate(purchase.date)}
            </div>
        `).join('')}
    </div>
    ${stock.purchaseHistory.length > 2 ? `<span class="history-toggle" onclick="toggleHistory(this, '${purchaseHistoryId}')">Show More</span>` : ''}
`;

const saleHistoryHtml = stock.saleHistory && stock.saleHistory.length > 0 ? `
    <div style="margin-top: 10px;">
        <strong>Sale History:</strong>
        <div class="history-content" id="sale-history-${stock.id}">
            ${stock.saleHistory.map(sale => `
                <div class="history-item" style="color: #ef4444;">
                    • Sold ${sale.quantity} shares @ ₹${sale.price.toFixed(2)} = ₹${sale.totalAmount.toFixed(2)} on ${formatDate(sale.date)}
                </div>
            `).join('')}
        </div>
        ${stock.saleHistory.length > 2 ? `<span class="history-toggle" onclick="toggleHistory(this, 'sale-history-${stock.id}')">Show More</span>` : ''}
    </div>
` : '';
        
        const statusText = stock.currentQuantity > 0 ? 
            `Holding: ${stock.currentQuantity} shares • Avg Price: ₹${avgPrice.toFixed(2)}` :
            `Fully Sold • Original Investment: ₹${totalInvested.toFixed(2)} • Total Sold: ₹${totalSold.toFixed(2)}`;
        
        return `
            <div class="item-card investments">
                <div class="item-header">
                    <div class="item-title">${stock.stockName}</div>
                    <div class="item-amount">₹${stock.currentQuantity > 0 ? currentValue.toFixed(2) : totalSold.toFixed(2)}</div>
                </div>
                <div class="item-details">${statusText}</div>
                <div class="item-details">
                    <strong>Purchase History:</strong>
                    ${purchaseHistoryHtml}
                    ${saleHistoryHtml}
                </div>
                <div class="item-actions">
                    ${stock.currentQuantity > 0 ? `<button class="btn-edit" style="background: #ef4444;" onclick="showSellForm('${stock.id}', 'stock')">Sell</button>` : ''} 
<button class="btn-edit" style="background: #22c55e;" onclick="showBuyForm('${stock.id}')">Buy</button>

                    <button class="btn-delete" onclick="deleteStock('${stock.id}')">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

function displayMutualFunds() {
    const mutualFunds = loadFromStorage('mutualFunds');
    const container = document.getElementById('mutual-funds-list');
    
    if (mutualFunds.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No mutual funds purchased yet. Start your first investment!</div>';
        return;
    }

    container.innerHTML = mutualFunds.map(fund => {
    const sipPaymentsTotal = fund.sipPayments ? fund.sipPayments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
    const totalInvested = fund.isSip ? sipPaymentsTotal : (fund.totalInvested || fund.amount || 0);
    
    // For SIP funds, use the monthly amount for display, for one-time use total invested
    const displayAmount = fund.isSip ? (fund.amount || 0) : totalInvested;
        const totalWithdrawn = fund.withdrawalHistory ? fund.withdrawalHistory.reduce((sum, withdrawal) => sum + withdrawal.amount, 0) : 0;
const availableAmount = totalInvested - totalWithdrawn;
const isFullyWithdrawn = availableAmount <= 0;

const withdrawalHistoryHtml = fund.withdrawalHistory && fund.withdrawalHistory.length > 0 ? `
    <div class="item-details">
        <strong>Withdrawal History:</strong>
        <div class="history-content" id="withdrawal-history-${fund.id}">
            ${fund.withdrawalHistory.map(withdrawal => `
                <div class="history-item" style="color: #ef4444;">
                    • Withdrew ₹${withdrawal.amount.toFixed(2)} on ${formatDate(withdrawal.date)}
                </div>
            `).join('')}
        </div>
        ${fund.withdrawalHistory.length > 2 ? `<span class="history-toggle" onclick="toggleHistory(this, 'withdrawal-history-${fund.id}')">Show More</span>` : ''}
    </div>
` : '';

return `
    <div class="item-card investments">
        <div class="item-header">
            <div class="item-title">${fund.fundName}</div>
            <div class="item-amount">₹${isFullyWithdrawn ? '0.00' : availableAmount.toFixed(2)}</div>
        </div>
        <div class="item-details">
            ${fund.isSip 
       ? `SIP: ₹${fund.amount || 0}/month • Total invested: ₹${totalInvested.toFixed(2)}` 
       : `One-time Investment • Invested: ₹${totalInvested.toFixed(2)}`} • Started: ${formatDate(fund.date)}
        </div>
        ${totalWithdrawn > 0 ? `<div class="item-details">Available: ₹${availableAmount.toFixed(2)} • Withdrawn: ₹${totalWithdrawn.toFixed(2)}</div>` : ''}
        ${withdrawalHistoryHtml}
        <div class="item-actions">
            ${fund.isSip ? `<button class="btn-edit" style="background: #3b82f6;" onclick="changeSipAmount('${fund.id}')">Change SIP</button>` : ''}
            ${!isFullyWithdrawn ? `<button class="btn-edit" style="background: #ef4444;" onclick="showSellForm('${fund.id}', 'mutual-fund')">Withdraw</button>` : ''}
            <button class="btn-delete" onclick="deleteMutualFund('${fund.id}')">Delete</button>
        </div>
    </div>
`;
    }).join('');
}

// Sell/Withdraw Functions
function showSellForm(investmentId, type) {
    const form = document.getElementById('sell-withdraw-form');
    const title = document.getElementById('sell-withdraw-title');
    const quantityLabel = document.getElementById('quantity-amount-label');
    
    currentSellWithdrawId = investmentId;
    currentSellWithdrawType = type;
    
    if (type === 'stock') {
        title.textContent = 'Sell Stock';
        quantityLabel.textContent = 'Quantity to Sell';
        
        const stocks = loadFromStorage('stocks');
        const stock = stocks.find(s => s.id === investmentId);
        document.getElementById('sell-quantity-amount').max = stock.currentQuantity;
        document.getElementById('sell-quantity-amount').placeholder = `Max: ${stock.currentQuantity} shares`;
    } else {
    title.textContent = 'Withdraw from Mutual Fund';
    quantityLabel.textContent = 'Amount to Withdraw';
    
    const mutualFunds = loadFromStorage('mutualFunds');
    const fund = mutualFunds.find(f => f.id === investmentId);
    
    if (fund) {
        // Calculate available amount
        const currentValue = fund.isSip ? 
            (fund.sipPayments ? fund.sipPayments.reduce((sum, payment) => sum + payment.amount, 0) : fund.totalInvested || fund.amount) :
            (fund.totalInvested || fund.amount);
        
        const alreadyWithdrawn = fund.withdrawalHistory ? 
            fund.withdrawalHistory.reduce((sum, withdrawal) => sum + withdrawal.amount, 0) : 0;
        
        const availableAmount = currentValue - alreadyWithdrawn;
        
        document.getElementById('sell-quantity-amount').max = availableAmount;
        document.getElementById('sell-quantity-amount').placeholder = `Max: ₹${availableAmount.toFixed(2)}`;
    } else {
        document.getElementById('sell-quantity-amount').placeholder = 'Enter amount';
    }
}
    
    populateInvestmentDebitCards();
    document.getElementById('sell-date').value = new Date().toISOString().split('T')[0];
    form.classList.remove('hidden');
}


function showBuyForm(stockId) {
    const stocks = loadFromStorage('stocks');
    const stock = stocks.find(s => s.id === stockId);
    
    if (!stock) return;
    
    // Set up the form for buying more shares
    document.getElementById('investments-form').classList.remove('hidden');
    document.getElementById('investment-type').value = 'stock';
    handleInvestmentTypeChange();
    populateInvestmentDebitCards();
    
    // Pre-fill the stock name (readonly)
    document.getElementById('stock-name').value = stock.stockName;
    document.getElementById('stock-name').readOnly = true;
    document.getElementById('stock-name').style.backgroundColor = '#f9f9f9';
    
    // Clear other fields
    document.getElementById('stock-quantity').value = '';
    document.getElementById('stock-price').value = '';
    document.getElementById('investment-payment-mode').value = '';
    document.getElementById('investment-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('investment-notes').value = '';
    
    // Mark that we're buying more of existing stock
    document.getElementById('investments-form').setAttribute('data-existing-stock-id', stockId);
}

function processSellWithdraw() {
    const quantityAmount = parseFloat(document.getElementById('sell-quantity-amount').value);
    const priceRate = parseFloat(document.getElementById('sell-price-rate').value);
    const debitCardId = document.getElementById('credit-debit-card').value;
    const date = document.getElementById('sell-date').value;
    
    if (!quantityAmount || !priceRate || !debitCardId || !date) {
        alert('Please fill in all fields');
        return;
    }
    
    const totalAmount = quantityAmount * priceRate;
    
    if (currentSellWithdrawType === 'stock') {
        const stocks = loadFromStorage('stocks');
        const stockIndex = stocks.findIndex(s => s.id === currentSellWithdrawId);
        
        if (stockIndex !== -1 && stocks[stockIndex].currentQuantity >= quantityAmount) {
            stocks[stockIndex].currentQuantity -= quantityAmount;
            
            // Add sale history
            if (!stocks[stockIndex].saleHistory) stocks[stockIndex].saleHistory = [];
            stocks[stockIndex].saleHistory.push({
                id: generateId(),
                quantity: quantityAmount,
                price: priceRate,
                totalAmount,
                date,
                creditedTo: debitCardId
            });
            
            // Don't remove stock even if quantity becomes 0 - keep history
            saveToStorage('stocks', stocks);
        }
    } else {
    const mutualFunds = loadFromStorage('mutualFunds');
    const fundIndex = mutualFunds.findIndex(f => f.id === currentSellWithdrawId);
    
    if (fundIndex !== -1) {
        const fund = mutualFunds[fundIndex];
        
        // Calculate current fund value
        const currentValue = fund.isSip ? 
            (fund.sipPayments ? fund.sipPayments.reduce((sum, payment) => sum + payment.amount, 0) : fund.totalInvested || fund.amount) :
            (fund.totalInvested || fund.amount);
        
        // Calculate already withdrawn amount
        const alreadyWithdrawn = fund.withdrawalHistory ? 
            fund.withdrawalHistory.reduce((sum, withdrawal) => sum + withdrawal.amount, 0) : 0;
        
        const availableAmount = currentValue - alreadyWithdrawn;
        
        // Validate withdrawal amount
        if (quantityAmount > availableAmount) {
            alert(`Insufficient balance! Available amount: ₹${availableAmount.toFixed(2)}`);
            return;
        }
        
        // Add withdrawal history
        if (!fund.withdrawalHistory) fund.withdrawalHistory = [];
        fund.withdrawalHistory.push({
            id: generateId(),
            amount: quantityAmount,
            rate: priceRate,
            totalAmount,
            date,
            creditedTo: debitCardId,
            timestamp: new Date().toISOString()
        });
        
        // Update fund status if fully withdrawn
        const totalWithdrawn = fund.withdrawalHistory.reduce((sum, withdrawal) => sum + withdrawal.amount, 0);
        if (totalWithdrawn >= currentValue) {
            fund.status = 'closed';
        }
        
        saveToStorage('mutualFunds', mutualFunds);
    }
}
    
    // Credit bank account
    updateDebitCardBalance(debitCardId, totalAmount, false);
    
    // Add to money in instead of income
const moneyIn = loadFromStorage('moneyIn');
moneyIn.push({
    id: generateId(),
    type: currentSellWithdrawType === 'stock' ? 'stock_sale' : 'mutual_fund_withdrawal',
    description: currentSellWithdrawType === 'stock' ? `Stock Sale: ${quantityAmount} shares` : `Mutual Fund Withdrawal: ₹${quantityAmount}`,
    amount: totalAmount,
    date,
    creditedTo: debitCardId,
    notes: `Investment transaction - ${currentSellWithdrawType === 'stock' ? 'Stock' : 'Mutual Fund'} ${currentSellWithdrawType === 'stock' ? 'sale' : 'withdrawal'}`,
    createdAt: new Date().toISOString()
});
saveToStorage('moneyIn', moneyIn);
    
    cancelSellWithdrawForm();
    loadModuleData('investments');
}
function cancelSellWithdrawForm() {
    document.getElementById('sell-withdraw-form').classList.add('hidden');
    currentSellWithdrawId = null;
    currentSellWithdrawType = null;
}

// SIP Payment Functions
function showSipPaymentForm() {
    document.getElementById('sip-payment-form').classList.remove('hidden');
    populateSipFunds();
    populateInvestmentDebitCards();
    document.getElementById('sip-payment-date').value = new Date().toISOString().split('T')[0];
}

function populateSipFunds() {
    const mutualFunds = loadFromStorage('mutualFunds') || [];
    const sipFunds = mutualFunds.filter(f => f.isSip);
    const select = document.getElementById('sip-fund-select');
    
    select.innerHTML = '<option value="">' + "Choose SIP Fund" + '</option>';
    sipFunds.forEach(fund => {
        const option = document.createElement('option');
        option.value = fund.id;
        option.textContent = fund.fundName + ' - ₹' + (fund.amount || 0) + '/month';
        select.appendChild(option);
    });

    // NEW: auto-fill payment amount
    select.onchange = function() {
        const fundId = this.value;
        const amountInput = document.getElementById('sip-payment-amount');
        if (!amountInput) return;
        if (!fundId) { amountInput.value = ''; return; }
        const allFunds = loadFromStorage('mutualFunds') || [];
        const fund = allFunds.find(f => f.id === fundId);
        if (fund) {
            amountInput.value = fund.amount || '';
        } else {
            amountInput.value = '';
        }
    };
}


function handleSipPaymentModeChange() {
    const paymentMode = document.getElementById('sip-payment-mode').value;
    const debitCardSection = document.getElementById('sip-debit-card-selection');
    
    if (paymentMode === 'debit-card') {
        debitCardSection.classList.remove('hidden');
    } else {
        debitCardSection.classList.add('hidden');
    }
}

function saveSipPayment() {
    const fundId = document.getElementById('sip-fund-select').value;
    const amount = parseFloat(document.getElementById('sip-payment-amount').value);
    const date = document.getElementById('sip-payment-date').value;
    const paymentMode = document.getElementById('sip-payment-mode').value;
    const debitCardId = document.getElementById('sip-debit-card').value;
    
    if (!fundId || !amount || !date || !paymentMode) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (paymentMode === 'debit-card' && !debitCardId) {
        alert('Please select a debit card');
        return;
    }
    
    const mutualFunds = loadFromStorage('mutualFunds');
    const fundIndex = mutualFunds.findIndex(f => f.id === fundId);
    
    if (fundIndex !== -1) {
        if (!mutualFunds[fundIndex].sipPayments) {
            mutualFunds[fundIndex].sipPayments = [];
        }
        
        mutualFunds[fundIndex].sipPayments.push({
    id: generateId(),
    amount,
    date,
    paymentMode,
    debitCardId,
    status: 'paid'
});

// Update the total invested amount
const totalSipPayments = mutualFunds[fundIndex].sipPayments.reduce((sum, payment) => sum + payment.amount, 0);
mutualFunds[fundIndex].totalInvested = totalSipPayments;

saveToStorage('mutualFunds', mutualFunds);
        
        // Update bank balance if debit card used
        if (paymentMode === 'debit-card' && debitCardId) {
            updateDebitCardBalance(debitCardId, amount, true);
        }
        
        // Add to money out instead of expenses
const moneyOut = loadFromStorage('moneyOut');
moneyOut.push({
    id: generateId(),
    type: 'sip_payment',
    description: `SIP Payment: ${mutualFunds[fundIndex].fundName}`,
    amount,
    paymentMode,
    debitCardId,
    date,
    notes: 'Monthly SIP investment payment',
    createdAt: new Date().toISOString()
});
saveToStorage('moneyOut', moneyOut);
    }
    
    cancelSipPaymentForm();
    displaySipPayments();
}

function cancelSipPaymentForm() {
    document.getElementById('sip-payment-form').classList.add('hidden');
}

function displaySipPayments() {
    const mutualFunds = loadFromStorage('mutualFunds');
    const container = document.getElementById('sip-payments-list');
    
    let allSipPayments = [];
    mutualFunds.forEach(fund => {
        if (fund.isSip && fund.sipPayments) {
            fund.sipPayments.forEach(payment => {
                allSipPayments.push({
                    ...payment,
                    fundName: fund.fundName,
                    fundId: fund.id
                });
            });
        }
    });
    
    if (allSipPayments.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No SIP payments recorded yet.</div>';
        return;
    }
    
    allSipPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Group SIP payments by fund
const groupedPayments = {};
allSipPayments.forEach(payment => {
    if (!groupedPayments[payment.fundId]) {
        groupedPayments[payment.fundId] = {
            fundName: payment.fundName,
            payments: []
        };
    }
    groupedPayments[payment.fundId].payments.push(payment);
});

container.innerHTML = Object.keys(groupedPayments).map(fundId => {
    const fundData = groupedPayments[fundId];
    const payments = fundData.payments.sort((a, b) => new Date(b.date) - new Date(a.date));
    const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
    
    const sipPaymentsHtml = `
        <div class="history-content" id="sip-payments-${fundId}">
            ${payments.map(payment => {
                const debitCards = loadFromStorage('debitCards');
                const card = debitCards.find(c => c.id === payment.debitCardId);
                const paymentInfo = card ? ` • ${payment.paymentMode.toUpperCase()}: ${card.bankName} *${card.lastDigits}` : ` • ${payment.paymentMode.toUpperCase()}`;
                
                return `
                    <div class="history-item">
                        • ₹${payment.amount.toFixed(2)} on ${formatDate(payment.date)}${paymentInfo}
                    </div>
                `;
            }).join('')}
        </div>
        ${payments.length > 3 ? `<span class="history-toggle" onclick="toggleHistory(this, 'sip-payments-${fundId}')">Show More</span>` : ''}
    `;
    
    return `
        <div class="item-card investments">
            <div class="item-header">
                <div class="item-title">${fundData.fundName}</div>
                <div class="item-amount">₹${totalPaid.toFixed(2)}</div>
            </div>
            <div class="item-details">
                <strong>Total Payments: ${payments.length} • Latest: ${formatDate(payments[0].date)}</strong>
            </div>
            <div class="item-details">
                <strong>Payment History:</strong>
                ${sipPaymentsHtml}
            </div>
        </div>
    `;
}).join('');
}

// Delete Functions
function deleteStock(id) {
    if (confirm('Are you sure you want to delete this stock and all its history?')) {
        const stocks = loadFromStorage('stocks');
        const filtered = stocks.filter(stock => stock.id !== id);
        saveToStorage('stocks', filtered);
        loadModuleData('investments');
    }
}

function deleteMutualFund(id) {
    if (confirm('Are you sure you want to delete this mutual fund and all its history?')) {
        const mutualFunds = loadFromStorage('mutualFunds');
        const filtered = mutualFunds.filter(fund => fund.id !== id);
        saveToStorage('mutualFunds', filtered);
        loadModuleData('investments');
    }
}

function changeSipAmount(fundId) {
    const mutualFunds = loadFromStorage('mutualFunds');
    const fund = mutualFunds.find(f => f.id === fundId);
    
    if (!fund || !fund.isSip) return;
    
    const newAmount = prompt(`Current SIP amount: ₹${fund.amount}/month\nEnter new SIP amount:`);
    
    if (newAmount && !isNaN(newAmount) && parseFloat(newAmount) > 0) {
        const amount = parseFloat(newAmount);
        const fundIndex = mutualFunds.findIndex(f => f.id === fundId);
        
        if (fundIndex !== -1) {
            // Update the amount
            mutualFunds[fundIndex].amount = amount;
            saveToStorage('mutualFunds', mutualFunds);
            
            // Force complete refresh of the investments module
            loadModuleData('investments');
            
            alert(`SIP amount updated to ₹${amount}/month`);
        }
    }
}

        // Data loading functions
        function loadAllData() {
    // Initialize storage if empty
    if (!localStorage.getItem('incomes')) saveToStorage('incomes', []);
    if (!localStorage.getItem('expenses')) saveToStorage('expenses', []);
    if (!localStorage.getItem('lends')) saveToStorage('lends', []);
    if (!localStorage.getItem('borrows')) saveToStorage('borrows', []);
    if (!localStorage.getItem('emis')) saveToStorage('emis', []);
    if (!localStorage.getItem('debitCards')) saveToStorage('debitCards', []);
if (!localStorage.getItem('creditCards')) saveToStorage('creditCards', []);
if (!localStorage.getItem('creditBills')) saveToStorage('creditBills', []);
if (!localStorage.getItem('stocks')) saveToStorage('stocks', []);
if (!localStorage.getItem('mutualFunds')) saveToStorage('mutualFunds', []);
if (!localStorage.getItem('moneyIn')) saveToStorage('moneyIn', []);
if (!localStorage.getItem('moneyOut')) saveToStorage('moneyOut', []);
if (!localStorage.getItem('documents')) saveToStorage('documents', Array(6).fill(null));
}


        function loadModuleData(module) {
    switch(module) {
        case 'income':
            displayIncomes();
            break;
        case 'expense':
            displayExpenses();
            break;
        case 'lend':
            displayLends();
            break;
        case 'borrow':
            displayBorrows();
            break;
        case 'emi':
            displayEMIs();
            displayEmiPayments();
            break;
        case 'debit-cards':
            displayDebitCards();
            break;
case 'credit-cards':
    displayCreditCards();
    displayCreditBills();
    break;
        case 'stats':
            displayStats();
            break;
case 'investments':
    displayStocks();
    displayMutualFunds();
    displaySipPayments();
    break;
case 'documents':
    initializeDocumentCards();
    break;

    }
}

        function displayIncomes() {
            const incomes = loadFromStorage('incomes');
            const container = document.getElementById('income-list');
            
            if (incomes.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No income records yet. Add your first income!</div>';
                return;
            }

            container.innerHTML = incomes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(income => `
                <div class="item-card income">
                    <div class="item-header">
                        <div class="item-title">${income.source}</div>
                        <div class="item-amount">+₹${income.amount.toFixed(2)}</div>
                    </div>
                    <div class="item-details">${formatDate(income.date)}</div>
                    ${income.notes ? `<div class="item-details">${income.notes}</div>` : ''}
                    <div class="item-actions">
                        <button class="btn-edit" onclick="editIncome('${income.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteIncome('${income.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

function displayExpenses() {
    const expenses = loadFromStorage('expenses');
    const container = document.getElementById('expense-list');
    
    if (expenses.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No expense records yet. Add your first expense!</div>';
        return;
    }

    container.innerHTML = expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(expense => {
        let paymentInfo = '';
        if (expense.paymentMode) {
            if (expense.paymentMode === 'debit-card' || expense.paymentMode === 'upi') {
                const debitCards = loadFromStorage('debitCards');
                const card = debitCards.find(c => c.id === expense.debitCardId);
                paymentInfo = card ? ` • ${expense.paymentMode.toUpperCase()}: ${card.bankName} *${card.lastDigits}` : ` • ${expense.paymentMode.toUpperCase()}`;
            } else if (expense.paymentMode === 'credit-card') {
                paymentInfo = ` • CREDIT: ${expense.creditCard}`;
            } else {
                paymentInfo = ` • ${expense.paymentMode.toUpperCase()}`;
            }
        }
        
        return `
            <div class="item-card expense">
                <div class="item-header">
                    <div class="item-title">${expense.description}</div>
                    <div class="item-amount expense">-₹${expense.amount.toFixed(2)}</div>
                </div>
                <div class="item-details">${getCategoryName(expense.category)} • ${formatDate(expense.date)}${paymentInfo}</div>
                ${expense.notes ? `<div class="item-details">${expense.notes}</div>` : ''}
                <div class="item-actions">
                    <button class="btn-edit" onclick="editExpense('${expense.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteExpense('${expense.id}')">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}
        function displayLends() {
    const lends = loadFromStorage('lends');
    const container = document.getElementById('lend-list');
    
    if (lends.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No lending records yet. Add your first lending!</div>';
        return;
    }

    container.innerHTML = lends.sort((a, b) => new Date(b.date) - new Date(a.date)).map(lend => {
        const outstandingAmount = lend.amount - (lend.totalReturned || 0);
        
        // Generate payment logs display
        const paymentLogsHtml = lend.paymentLogs && lend.paymentLogs.length > 0 ? `
    <div class="item-details">
        <strong>Return History:</strong>
        <div class="history-content" id="return-history-${lend.id}">
            ${lend.paymentLogs.map(log => 
                `<div class="history-item">
                    • ₹${log.amount.toFixed(2)} on ${formatDate(log.date)}
                </div>`
            ).join('')}
        </div>
        ${lend.paymentLogs.length > 2 ? `<span class="history-toggle" onclick="toggleHistory(this, 'return-history-${lend.id}')">Show More</span>` : ''}
    </div>
` : '';
        
        return `
            <div class="item-card lend">
                <div class="item-header">
                    <div class="item-title">Lent to ${lend.person}</div>
                    <div class="item-amount">₹${lend.amount.toFixed(2)}</div>
                </div>
                <div class="item-details">Lent: ${formatDate(lend.date)} ${lend.returnDate ? '• Expected: ' + formatDate(lend.returnDate) : ''}</div>
                <div class="item-details">
                    Status: ${getStatusBadge(lend.status)} • 
                    Outstanding: ₹${outstandingAmount.toFixed(2)}
                </div>
                ${paymentLogsHtml}
                ${lend.notes ? `<div class="item-details">${lend.notes}</div>` : ''}
                <div class="item-actions">
                    ${lend.status === 'partial' ? `<button class="btn-edit" style="background: #22c55e;" onclick="addLendPayment('${lend.id}')">Add Return</button>` : ''}
                    <button class="btn-edit" onclick="editLend('${lend.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteLend('${lend.id}')">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

function displayBorrows() {
    const borrows = loadFromStorage('borrows');
    const container = document.getElementById('borrow-list');
    
    if (borrows.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No borrowing records yet. Add your first borrowing!</div>';
        return;
    }

    container.innerHTML = borrows.sort((a, b) => new Date(b.date) - new Date(a.date)).map(borrow => {
        const outstandingAmount = borrow.amount - (borrow.totalPaid || 0);
        
        // Generate payment logs display
        const paymentLogsHtml = borrow.paymentLogs && borrow.paymentLogs.length > 0 ? `
    <div class="item-details">
        <strong>Payment History:</strong>
        <div class="history-content" id="payment-history-${borrow.id}">
            ${borrow.paymentLogs.map(log => 
                `<div class="history-item">
                    • ₹${log.amount.toFixed(2)} on ${formatDate(log.date)}
                </div>`
            ).join('')}
        </div>
        ${borrow.paymentLogs.length > 2 ? `<span class="history-toggle" onclick="toggleHistory(this, 'payment-history-${borrow.id}')">Show More</span>` : ''}
    </div>
` : '';
        
        return `
            <div class="item-card borrow">
                <div class="item-header">
                    <div class="item-title">Borrowed from ${borrow.person}</div>
                    <div class="item-amount borrow">₹${borrow.amount.toFixed(2)}</div>
                </div>
                <div class="item-details">Borrowed: ${formatDate(borrow.date)} ${borrow.dueDate ? '• Due: ' + formatDate(borrow.dueDate) : ''}</div>
                <div class="item-details">
                    Status: ${getStatusBadge(borrow.status)} • 
                    Outstanding: ₹${outstandingAmount.toFixed(2)}
                </div>
                ${paymentLogsHtml}
                ${borrow.notes ? `<div class="item-details">${borrow.notes}</div>` : ''}
                <div class="item-actions">
                    ${borrow.status === 'partial' ? `<button class="btn-edit" style="background: #22c55e;" onclick="addBorrowPayment('${borrow.id}')">Add Payment</button>` : ''}
                    <button class="btn-edit" onclick="editBorrow('${borrow.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteBorrow('${borrow.id}')">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

        function displayEMIs() {
            const emis = loadFromStorage('emis');
            const container = document.getElementById('emi-list');
            
            if (emis.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No EMI records yet. Add your first EMI!</div>';
                return;
            }

            container.innerHTML = emis.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).map(emi => `
                <div class="item-card emi">
                    <div class="item-header">
                        <div class="item-title">${emi.name}</div>
                        <div class="item-amount">₹${emi.amount.toFixed(2)}/month</div>
                    </div>
                    <div class="item-details">${formatDate(emi.startDate)} to ${formatDate(emi.endDate)}</div>
                    <div class="item-details">${emi.bank ? emi.bank + ' • ' : ''}Status: ${getStatusBadge(emi.status)}</div>
                    ${emi.notes ? `<div class="item-details">${emi.notes}</div>` : ''}
                    <div class="item-actions">
                        <button class="btn-edit" onclick="editEMI('${emi.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteEMI('${emi.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayStats() {
    const incomes = loadFromStorage('incomes');
    const expenses = loadFromStorage('expenses');
    const lends = loadFromStorage('lends');
    const borrows = loadFromStorage('borrows');
    const emis = loadFromStorage('emis');
    const stocks = loadFromStorage('stocks');
    const mutualFunds = loadFromStorage('mutualFunds');

    // Calculate investment totals
    const totalStockInvestment = stocks.reduce((sum, stock) => {
        return sum + stock.purchaseHistory.reduce((stockSum, purchase) => stockSum + purchase.totalAmount, 0);
    }, 0);
    
    const totalMutualFundInvestment = mutualFunds.reduce((sum, fund) => {
        return sum + (fund.sipPayments ? fund.sipPayments.reduce((sipSum, payment) => sipSum + payment.amount, 0) : fund.amount);
    }, 0);

    // Calculate comprehensive money flow
const moneyIn = loadFromStorage('moneyIn');
const moneyOut = loadFromStorage('moneyOut');

const totalMoneyIn = moneyIn.reduce((sum, money) => sum + money.amount, 0);
const totalMoneyOut = moneyOut.reduce((sum, money) => sum + money.amount, 0);
const netCashFlow = totalMoneyIn - totalMoneyOut;

const totalIncome = incomes.reduce((sum, income) => sum + income.amount, 0);
const totalExpense = expenses.reduce((sum, expense) => sum + expense.amount, 0);

const totalInvestment = totalStockInvestment + totalMutualFundInvestment;
    const totalLent = lends.filter(l => l.status !== 'returned').reduce((sum, lend) => sum + lend.amount, 0);
    const totalBorrowed = borrows.filter(b => b.status !== 'paid').reduce((sum, borrow) => sum + borrow.amount, 0);
    const monthlyEMI = emis.filter(e => e.status === 'active').reduce((sum, emi) => sum + emi.amount, 0);
    const netWorth = totalIncome - totalExpense - totalInvestment + totalLent - totalBorrowed;

    const statsGrid = document.getElementById('stats-grid');
    statsGrid.innerHTML = `
    <div class="stat-card">
        <div class="stat-value" style="color: #22c55e;">₹${totalIncome.toFixed(2)}</div>
        <div class="stat-label">Total Income</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #ef4444;">₹${totalExpense.toFixed(2)}</div>
        <div class="stat-label">Total Expense</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #10b981;">₹${totalMoneyIn.toFixed(2)}</div>
        <div class="stat-label">Money In</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #f97316;">₹${totalMoneyOut.toFixed(2)}</div>
        <div class="stat-label">Money Out</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #7c3aed;">₹${totalInvestment.toFixed(2)}</div>
        <div class="stat-label">Total Investment</div>
    </div>
   
        <div class="stat-card">
            <div class="stat-value" style="color: #0ea5e9;">₹${totalLent.toFixed(2)}</div>
            <div class="stat-label">Money Lent</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #f59e0b;">₹${totalBorrowed.toFixed(2)}</div>
            <div class="stat-label">Money Borrowed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: ${netWorth >= 0 ? '#22c55e' : '#ef4444'};">₹${netWorth.toFixed(2)}</div>
            <div class="stat-label">Net Balance</div>
        </div>
    `;

   
            // Monthly breakdown
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const thisMonthIncome = incomes.filter(income => {
                const date = new Date(income.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).reduce((sum, income) => sum + income.amount, 0);

            const thisMonthExpense = expenses.filter(expense => {
                const date = new Date(expense.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).reduce((sum, expense) => sum + expense.amount, 0);

            const statsDetails = document.getElementById('stats-details');
            statsDetails.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 15px; margin-top: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom: 15px; font-size: 20px; color: #1f2937;">This Month</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; color: #22c55e;">₹${thisMonthIncome.toFixed(2)}</div>
                            <div style="font-size: 14px; color: #6b7280;">Income</div>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 600; color: #ef4444;">₹${thisMonthExpense.toFixed(2)}</div>
                            <div style="font-size: 14px; color: #6b7280;">Expense</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-size: 18px; font-weight: 600; color: ${thisMonthIncome - thisMonthExpense >= 0 ? '#22c55e' : '#ef4444'};">
                            ₹${(thisMonthIncome - thisMonthExpense).toFixed(2)}
                        </div>
                        <div style="font-size: 14px; color: #6b7280;">Monthly Balance</div>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function getCategoryName(category) {
            const categories = {
                'food': 'Food & Dining',
                'transport': 'Transportation',
                'shopping': 'Shopping',
                'bills': 'Bills & Utilities',
                'healthcare': 'Healthcare',
                'entertainment': 'Entertainment',
                'other': 'Other'
            };
            return categories[category] || category;
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span style="color: #f59e0b;">Pending</span>',
                'partial': '<span style="color: #3b82f6;">Partial</span>',
                'returned': '<span style="color: #22c55e;">Returned</span>',
                'paid': '<span style="color: #22c55e;">Paid</span>',
                'active': '<span style="color: #22c55e;">Active</span>',
                'completed': '<span style="color: #6b7280;">Completed</span>',
                'closed': '<span style="color: #ef4444;">Closed</span>'
            };
            return badges[status] || status;
        }
// Debit Card functions
        function saveDebitCard() {
            const bankName = document.getElementById('debit-bank-name').value.trim();
            const lastDigits = document.getElementById('debit-last-digits').value.trim();
            const balance = parseFloat(document.getElementById('debit-balance').value);
            const nickname = document.getElementById('debit-nickname').value.trim();

            if (!bankName || !lastDigits || isNaN(balance)) {
                alert('Please fill in all required fields');
                return;
            }

            const debitCards = loadFromStorage('debitCards');
            const card = {
                id: currentEditId || generateId(),
                bankName,
                lastDigits,
                balance,
                nickname,
                createdAt: currentEditId ? debitCards.find(c => c.id === currentEditId).createdAt : new Date().toISOString()
            };

            if (currentEditId) {
                const index = debitCards.findIndex(c => c.id === currentEditId);
                debitCards[index] = card;
            } else {
                debitCards.push(card);
            }

            saveToStorage('debitCards', debitCards);
            cancelForm('debit-cards');
            loadModuleData('debit-cards');
        }

        function deleteDebitCard(id) {
            if (confirm('Are you sure you want to delete this debit card?')) {
                const debitCards = loadFromStorage('debitCards');
                const filtered = debitCards.filter(card => card.id !== id);
                saveToStorage('debitCards', filtered);
                loadModuleData('debit-cards');
            }
        }

        function editDebitCard(id) {
    const debitCards = loadFromStorage('debitCards');
    const card = debitCards.find(c => c.id === id);
    
    if (card) {
        document.getElementById('debit-bank-name').value = card.bankName;
        document.getElementById('debit-last-digits').value = card.lastDigits;
        document.getElementById('debit-balance').value = card.balance;
        document.getElementById('debit-nickname').value = card.nickname || '';
        
        currentEditId = id;
        currentEditType = 'debit-cards';
        showAddForm('debit-cards');
    }
}

        function displayDebitCards() {
            const debitCards = loadFromStorage('debitCards');
            const container = document.getElementById('debit-cards-list');
            
            if (debitCards.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No debit cards registered yet. Add your first card!</div>';
                return;
            }

            container.innerHTML = debitCards.map(card => `
                <div class="item-card debit-cards">
                    <div class="item-header">
                        <div class="item-title">${card.bankName} - *${card.lastDigits}</div>
                        <div class="item-amount">₹${card.balance.toFixed(2)}</div>
                    </div>
                    ${card.nickname ? `<div class="item-details">${card.nickname}</div>` : ''}
                    <div class="item-actions">
                        <button class="btn-edit" onclick="editDebitCard('${card.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteDebitCard('${card.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateDebitCardBalance(cardId, amount, isDebit = true) {
            const debitCards = loadFromStorage('debitCards');
            const cardIndex = debitCards.findIndex(c => c.id === cardId);
            
            if (cardIndex !== -1) {
                if (isDebit) {
                    debitCards[cardIndex].balance -= amount;
                } else {
                    debitCards[cardIndex].balance += amount;
                }
                saveToStorage('debitCards', debitCards);
            }
        }
// Payment mode handling
function handlePaymentModeChange() {
    const paymentMode = document.getElementById('expense-payment-mode').value;
    const debitCardSection = document.getElementById('debit-card-selection');
    const creditCardSection = document.getElementById('credit-card-selection');
    
    // Hide all payment-specific sections
    debitCardSection.classList.add('hidden');
    creditCardSection.classList.add('hidden');
    
    if (paymentMode === 'debit-card' || paymentMode === 'upi') {
        debitCardSection.classList.remove('hidden');
        populateDebitCardOptions();
    } else if (paymentMode === 'credit-card') {
        creditCardSection.classList.remove('hidden');
        populateExpenseCreditCardOptions();
    }
}

function populateDebitCardOptions() {
    const debitCards = loadFromStorage('debitCards');
    const select = document.getElementById('expense-debit-card');
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Choose Debit Card</option>';
    
    debitCards.forEach(card => {
        const option = document.createElement('option');
        option.value = card.id;
        option.textContent = `${card.bankName} - *${card.lastDigits}${card.nickname ? ' (' + card.nickname + ')' : ''}`;
        select.appendChild(option);
    });
}
function populateExpenseCreditCardOptions() {
    const creditCards = loadFromStorage('creditCards');
    const select = document.getElementById('expense-credit-card');
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Choose Credit Card</option>';
    
    creditCards.forEach(card => {
        const option = document.createElement('option');
        option.value = card.id;
        option.textContent = `${card.cardName} - *${card.lastDigits}`;
        select.appendChild(option);
    });
}
// Credit Card functions
function saveCreditCard() {
    const cardName = document.getElementById('credit-card-name').value.trim();
    const lastDigits = document.getElementById('credit-last-digits').value.trim();
    const creditLimit = parseFloat(document.getElementById('credit-limit').value);
    const billDate = parseInt(document.getElementById('credit-bill-date').value);
    const dueDate = parseInt(document.getElementById('credit-due-date').value);

    if (!cardName || !lastDigits || isNaN(creditLimit) || isNaN(billDate) || isNaN(dueDate)) {
        alert('Please fill in all required fields');
        return;
    }

    const creditCards = loadFromStorage('creditCards');
    const card = {
        id: currentEditId || generateId(),
        cardName,
        lastDigits,
        creditLimit,
        billDate,
        dueDate,
        createdAt: currentEditId ? creditCards.find(c => c.id === currentEditId).createdAt : new Date().toISOString()
    };

    if (currentEditId) {
        const index = creditCards.findIndex(c => c.id === currentEditId);
        creditCards[index] = card;
    } else {
        creditCards.push(card);
    }

    saveToStorage('creditCards', creditCards);
    cancelForm('credit-cards');
    loadModuleData('credit-cards');
}

function deleteCreditCard(id) {
    if (confirm('Are you sure you want to delete this credit card?')) {
        const creditCards = loadFromStorage('creditCards');
        const filtered = creditCards.filter(card => card.id !== id);
        saveToStorage('creditCards', filtered);
        loadModuleData('credit-cards');
    }
}

function editCreditCard(id) {
    const creditCards = loadFromStorage('creditCards');
    const card = creditCards.find(c => c.id === id);
    
    if (card) {
        document.getElementById('credit-card-name').value = card.cardName;
        document.getElementById('credit-last-digits').value = card.lastDigits;
        document.getElementById('credit-limit').value = card.creditLimit;
        document.getElementById('credit-bill-date').value = card.billDate;
        document.getElementById('credit-due-date').value = card.dueDate;
        
        currentEditId = id;
        currentEditType = 'credit-cards';
        showAddForm('credit-cards');
    }
}

function displayCreditCards() {
    const creditCards = loadFromStorage('creditCards');
    const container = document.getElementById('credit-cards-list');
    
    if (creditCards.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No credit cards registered yet. Add your first card!</div>';
        return;
    }

    container.innerHTML = creditCards.map(card => `
        <div class="item-card credit-cards">
            <div class="item-header">
                <div class="item-title">${card.cardName} - *${card.lastDigits}</div>
                <div class="item-amount" style="color: #ea580c;">₹${card.creditLimit.toFixed(2)}</div>
            </div>
            <div class="item-details">Bill Date: ${card.billDate} • Due Date: ${card.dueDate}</div>
            <div class="item-actions">
                <button class="btn-edit" onclick="editCreditCard('${card.id}')">Edit</button>
                <button class="btn-delete" onclick="deleteCreditCard('${card.id}')">Delete</button>
            </div>
        </div>
    `).join('');
    
    // Update bill form credit card options
    populateCreditCardOptions();
}

// Credit Bill functions
function showBillForm() {
    document.getElementById('credit-bill-form').classList.remove('hidden');
    populateCreditCardOptions();
    
    // Set today's date only for new bills (not edits)
    if (!document.getElementById('credit-bill-form').getAttribute('data-edit-id')) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('bill-date').value = today;
        // Clear the form for new entries
        clearBillForm();
    }
}

function cancelBillForm() {
    document.getElementById('credit-bill-form').classList.add('hidden');
    // Remove edit ID if present
    document.getElementById('credit-bill-form').removeAttribute('data-edit-id');
    clearBillForm();
}

function clearBillForm() {
    const form = document.getElementById('credit-bill-form');
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type === 'date') {
            input.value = new Date().toISOString().split('T')[0];
        } else {
            input.value = '';
        }
    });
}

function populateCreditCardOptions() {
    const creditCards = loadFromStorage('creditCards');
    const select = document.getElementById('bill-credit-card');
    
    select.innerHTML = '<option value="">Select Credit Card</option>';
    
    creditCards.forEach(card => {
        const option = document.createElement('option');
        option.value = card.id;
        option.textContent = `${card.cardName} - *${card.lastDigits}`;
        select.appendChild(option);
    });
}

function saveCreditBill() {
    const creditCardId = document.getElementById('bill-credit-card').value;
    const amount = parseFloat(document.getElementById('bill-amount').value);
    const billDate = document.getElementById('bill-date').value;
    const dueDate = document.getElementById('bill-due-date').value;
    const status = document.getElementById('bill-status').value;
    const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
    const paymentDate = document.getElementById('payment-date').value;

    if (!creditCardId || !amount || !billDate || !dueDate) {
        alert('Please fill in all required fields');
        return;
    }

    // Validate payment details if status requires payment
    if ((status === 'paid' || status === 'partial') && (!paymentAmount || !paymentDate)) {
        alert('Please enter payment amount and date');
        return;
    }

    const creditBills = loadFromStorage('creditBills');
    const editId = document.getElementById('credit-bill-form').getAttribute('data-edit-id');
    
    let paymentLogs = [];
    let totalPaid = 0;

    if (editId) {
        // Keep existing payment logs for edited bills
        const existingBill = creditBills.find(b => b.id === editId);
        paymentLogs = existingBill.paymentLogs || [];
        totalPaid = paymentLogs.reduce((sum, log) => sum + log.amount, 0);
        
        // Don't add payment if it's the same as existing payment logs
        // Only add new payment amount if provided
        if (paymentAmount > 0 && paymentDate) {
            // Check if this is a new payment or just updating status
            const remainingAmount = amount - totalPaid;
            
            // Only record payment if there's actually a payment to record
            if (paymentAmount > 0 && paymentAmount <= remainingAmount) {
                paymentLogs.push({
                    id: generateId(),
                    amount: paymentAmount,
                    date: paymentDate,
                    timestamp: new Date().toISOString()
                });
                totalPaid += paymentAmount;
            }
        }
    } else {
        // For new bills, add payment if provided
        if (paymentAmount > 0 && paymentDate) {
            paymentLogs.push({
                id: generateId(),
                amount: paymentAmount,
                date: paymentDate,
                timestamp: new Date().toISOString()
            });
            totalPaid = paymentAmount;
        }
    }

    // Update status based on actual payments
    let finalStatus = status;
    if (totalPaid >= amount) {
        finalStatus = 'paid';
    } else if (totalPaid > 0) {
        finalStatus = 'partial';
    } else {
        finalStatus = 'pending';
    }

    const bill = {
        id: editId || generateId(),
        creditCardId,
        amount,
        billDate,
        dueDate,
        status: finalStatus,
        totalPaid,
        paymentLogs,
        createdAt: editId ? creditBills.find(b => b.id === editId).createdAt : new Date().toISOString()
    };

    if (editId) {
        const index = creditBills.findIndex(b => b.id === editId);
        creditBills[index] = bill;
        document.getElementById('credit-bill-form').removeAttribute('data-edit-id');
    } else {
        creditBills.push(bill);
    }

    // Add bill payment to money out and deduct from bank (if payment made)
    if (paymentAmount > 0 && paymentDate && (!editId || paymentAmount > 0)) {
        const moneyOut = loadFromStorage('moneyOut');
        moneyOut.push({
            id: generateId(),
            type: 'credit_card_payment',
            description: `Credit Card Bill Payment`,
            amount: paymentAmount,
            date: paymentDate,
            notes: 'Credit card bill payment',
            createdAt: new Date().toISOString()
        });
        saveToStorage('moneyOut', moneyOut);

        // Deduct from selected debit card (cash/bank)
        const debitCardId = document.getElementById('expense-debit-card')?.value;
        if (debitCardId) {
            updateDebitCardBalance(debitCardId, paymentAmount, true);
        }
    }

    saveToStorage('creditBills', creditBills);
    cancelBillForm();
    displayCreditBills();
}
function displayCreditBills() {
    const creditBills = loadFromStorage('creditBills');
    const creditCards = loadFromStorage('creditCards');
    const container = document.getElementById('credit-bills-list');
    
    if (creditBills.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No bills recorded yet. Add your first bill!</div>';
        return;
    }

    container.innerHTML = creditBills.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate)).map(bill => {
        const card = creditCards.find(c => c.id === bill.creditCardId);
        const cardName = card ? `${card.cardName} - *${card.lastDigits}` : 'Unknown Card';
        const outstandingAmount = bill.amount - (bill.totalPaid || 0);
        
        // Generate payment logs display
        const paymentLogsHtml = bill.paymentLogs && bill.paymentLogs.length > 0 ? `
    <div class="item-details">
        <strong>Payment History:</strong>
        <div class="history-content" id="bill-payment-history-${bill.id}">
            ${bill.paymentLogs.map(log => 
                `<div class="history-item">
                    • ₹${log.amount.toFixed(2)} on ${formatDate(log.date)}
                </div>`
            ).join('')}
        </div>
        ${bill.paymentLogs.length > 2 ? `<span class="history-toggle" onclick="toggleHistory(this, 'bill-payment-history-${bill.id}')">Show More</span>` : ''}
    </div>
` : '';
        
        return `
            <div class="item-card credit-cards">
                <div class="item-header">
                    <div class="item-title">${cardName}</div>
                    <div class="item-amount" style="color: #ea580c;">₹${bill.amount.toFixed(2)}</div>
                </div>
                <div class="item-details">Bill: ${formatDate(bill.billDate)} • Due: ${formatDate(bill.dueDate)}</div>
                <div class="item-details">
                    Status: ${getStatusBadge(bill.status)} • 
                    Outstanding: ₹${outstandingAmount.toFixed(2)}
                </div>
                ${paymentLogsHtml}
                <div class="item-actions">
                    ${bill.status === 'partial' ? `<button class="btn-edit" style="background: #22c55e;" onclick="addPayment('${bill.id}')">Add Payment</button>` : ''}
                    <button class="btn-edit" onclick="editCreditBill('${bill.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteCreditBill('${bill.id}')">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}
function deleteCreditBill(id) {
    if (confirm('Are you sure you want to delete this bill?')) {
        const creditBills = loadFromStorage('creditBills');
        const filtered = creditBills.filter(bill => bill.id !== id);
        saveToStorage('creditBills', filtered);
        displayCreditBills();
    }
}

function editCreditBill(id) {
    const creditBills = loadFromStorage('creditBills');
    const bill = creditBills.find(b => b.id === id);
    
    if (bill) {
        document.getElementById('credit-bill-form').classList.remove('hidden');
        populateCreditCardOptions();
        
        document.getElementById('bill-credit-card').value = bill.creditCardId;
        document.getElementById('bill-amount').value = bill.amount;
        document.getElementById('bill-date').value = bill.billDate;
        document.getElementById('bill-due-date').value = bill.dueDate;
        document.getElementById('bill-status').value = bill.status;
        
        // Handle payment section visibility
        handleBillStatusChange();
        
        // Clear payment fields for editing (don't pre-fill)
        document.getElementById('payment-amount').value = '';
        document.getElementById('payment-date').value = '';
        
        document.getElementById('credit-bill-form').setAttribute('data-edit-id', id);
    }
}
// Handle bill status change
function handleBillStatusChange() {
    const status = document.getElementById('bill-status').value;
    const paymentSection = document.getElementById('payment-section');
    const paymentAmount = document.getElementById('payment-amount');
    const billAmount = parseFloat(document.getElementById('bill-amount').value) || 0;
    
    // Get existing payment logs if editing
    const editId = document.getElementById('credit-bill-form').getAttribute('data-edit-id');
    let existingTotalPaid = 0;
    
    if (editId) {
        const creditBills = loadFromStorage('creditBills');
        const existingBill = creditBills.find(b => b.id === editId);
        if (existingBill && existingBill.paymentLogs) {
            existingTotalPaid = existingBill.paymentLogs.reduce((sum, log) => sum + log.amount, 0);
        }
    }
    
    const remainingAmount = billAmount - existingTotalPaid;
    
    if (status === 'paid' || status === 'partial') {
        paymentSection.classList.remove('hidden');
        
        // Auto-fill payment amount based on status and existing payments
        if (status === 'paid' && billAmount > 0) {
            // Only fill the remaining amount, not the full bill amount
            paymentAmount.value = remainingAmount > 0 ? remainingAmount.toFixed(2) : '0.00';
            paymentAmount.setAttribute('data-remaining', remainingAmount);
        } else if (status === 'partial') {
            // For partial status, clear the amount and show remaining
            paymentAmount.value = '';
            paymentAmount.setAttribute('data-remaining', remainingAmount);
            paymentAmount.placeholder = `Remaining: ₹${remainingAmount.toFixed(2)}`;
        }
        
        // Set today as default payment date
        const paymentDate = document.getElementById('payment-date');
        if (!paymentDate.value) {
            paymentDate.value = new Date().toISOString().split('T')[0];
        }
    } else {
        paymentSection.classList.add('hidden');
    }
}


function addPayment(billId) {
    const creditBills = loadFromStorage('creditBills');
    const bill = creditBills.find(b => b.id === billId);
    
    if (!bill) return;
    
    const remainingAmount = bill.amount - (bill.totalPaid || 0);
    const paymentAmount = prompt(`Outstanding amount: ₹${remainingAmount.toFixed(2)}\nEnter payment amount:`);
    
    if (paymentAmount && !isNaN(paymentAmount) && parseFloat(paymentAmount) > 0) {
        const amount = parseFloat(paymentAmount);
        const today = new Date().toISOString().split('T')[0];
        
        if (!bill.paymentLogs) bill.paymentLogs = [];
        
        bill.paymentLogs.push({
            id: generateId(),
            amount: amount,
            date: today,
            timestamp: new Date().toISOString()
        });
        
        bill.totalPaid = (bill.totalPaid || 0) + amount;
        
        // Update status if fully paid
        if (bill.totalPaid >= bill.amount) {
            bill.status = 'paid';
        }
        
        saveToStorage('creditBills', creditBills);
        displayCreditBills();
    }
}

// Lending status change handler
function handleLendStatusChange() {
    const status = document.getElementById('lend-status').value;
    const paymentSection = document.getElementById('lend-payment-section');
    const paymentAmount = document.getElementById('lend-payment-amount');
    const lendAmount = parseFloat(document.getElementById('lend-amount').value) || 0;
    
    // Get existing payment logs if editing
    const editId = currentEditId;
    let existingTotalReturned = 0;
    
    if (editId) {
        const lends = loadFromStorage('lends');
        const existingLend = lends.find(l => l.id === editId);
        if (existingLend && existingLend.paymentLogs) {
            existingTotalReturned = existingLend.paymentLogs.reduce((sum, log) => sum + log.amount, 0);
        }
    }
    
    const remainingAmount = lendAmount - existingTotalReturned;
    
    if (status === 'returned' || status === 'partial') {
        paymentSection.classList.remove('hidden');
        
        // Auto-fill payment amount based on status and existing returns
        if (status === 'returned' && lendAmount > 0) {
            // Only fill the remaining amount, not the full lent amount
            paymentAmount.value = remainingAmount > 0 ? remainingAmount.toFixed(2) : '0.00';
        } else if (status === 'partial') {
            // For partial status, clear the amount and show remaining
            paymentAmount.value = '';
            paymentAmount.placeholder = `Remaining: ₹${remainingAmount.toFixed(2)}`;
        }
        
        // Set today as default payment date
        const paymentDate = document.getElementById('lend-payment-date');
        if (!paymentDate.value) {
            paymentDate.value = new Date().toISOString().split('T')[0];
        }
    } else {
        paymentSection.classList.add('hidden');
    }
}

// Borrowing status change handler
function handleBorrowStatusChange() {
    const status = document.getElementById('borrow-status').value;
    const paymentSection = document.getElementById('borrow-payment-section');
    const paymentAmount = document.getElementById('borrow-payment-amount');
    const borrowAmount = parseFloat(document.getElementById('borrow-amount').value) || 0;
    
    // Get existing payment logs if editing
    const editId = currentEditId;
    let existingTotalPaid = 0;
    
    if (editId) {
        const borrows = loadFromStorage('borrows');
        const existingBorrow = borrows.find(b => b.id === editId);
        if (existingBorrow && existingBorrow.paymentLogs) {
            existingTotalPaid = existingBorrow.paymentLogs.reduce((sum, log) => sum + log.amount, 0);
        }
    }
    
    const remainingAmount = borrowAmount - existingTotalPaid;
    
    if (status === 'paid' || status === 'partial') {
        paymentSection.classList.remove('hidden');
        
        // Auto-fill payment amount based on status and existing payments
        if (status === 'paid' && borrowAmount > 0) {
            // Only fill the remaining amount, not the full borrowed amount
            paymentAmount.value = remainingAmount > 0 ? remainingAmount.toFixed(2) : '0.00';
        } else if (status === 'partial') {
            // For partial status, clear the amount and show remaining
            paymentAmount.value = '';
            paymentAmount.placeholder = `Remaining: ₹${remainingAmount.toFixed(2)}`;
        }
        
        // Set today as default payment date
        const paymentDate = document.getElementById('borrow-payment-date');
        if (!paymentDate.value) {
            paymentDate.value = new Date().toISOString().split('T')[0];
        }
    } else {
        paymentSection.classList.add('hidden');
    }
}

function toggleHistory(element, historyId) {
    const historyContent = document.getElementById(historyId);
    const isExpanded = historyContent.classList.contains('expanded');
    
    if (isExpanded) {
        historyContent.classList.remove('expanded');
        element.textContent = 'Show More';
    } else {
        historyContent.classList.add('expanded');
        element.textContent = 'Show Less';
    }
}

function showEmiPaymentForm() {
    document.getElementById('emi-payment-form').classList.remove('hidden');
    populateEmiOptions();
    populateInvestmentDebitCards();
    document.getElementById('emi-payment-date').value = new Date().toISOString().split('T')[0];
}

function populateEmiOptions() {
    const emis = loadFromStorage('emis').filter(e => e.status === 'active');
    const select = document.getElementById('emi-select');
    
    select.innerHTML = '<option value="">Choose EMI</option>';
    emis.forEach(emi => {
        const option = document.createElement('option');
        option.value = emi.id;
        option.textContent = `${emi.name} - ₹${emi.amount}/month`;
        select.appendChild(option);
    });

    // Auto-fill payment amount
    select.onchange = function() {
        const emiId = this.value;
        const amountInput = document.getElementById('emi-payment-amount');
        if (!emiId) { amountInput.value = ''; return; }
        const selectedEmi = emis.find(e => e.id === emiId);
        if (selectedEmi) {
            amountInput.value = selectedEmi.amount;
        }
    };
}

function saveEmiPayment() {
    const emiId = document.getElementById('emi-select').value;
    const amount = parseFloat(document.getElementById('emi-payment-amount').value);
    const date = document.getElementById('emi-payment-date').value;
    const paymentMode = document.getElementById('emi-payment-mode').value;
    const debitCardId = document.getElementById('emi-debit-card').value;
    
    if (!emiId || !amount || !date || !paymentMode) {
        alert('Please fill in all required fields');
        return;
    }
    
    const emis = loadFromStorage('emis');
    const emi = emis.find(e => e.id === emiId);
    
    if (!emi) return;
    
    // Update debit card balance if applicable
    if (paymentMode === 'debit-card' && debitCardId) {
        updateDebitCardBalance(debitCardId, amount, true);
    }
    
    // Add to money out
    const moneyOut = loadFromStorage('moneyOut');
    moneyOut.push({
        id: generateId(),
        type: 'emi_payment',
        description: `EMI Payment: ${emi.name}`,
        amount,
        paymentMode,
        debitCardId,
        date,
        notes: 'Monthly EMI payment',
        createdAt: new Date().toISOString()
    });
    saveToStorage('moneyOut', moneyOut);
    
    cancelEmiPaymentForm();
    displayEmiPayments(); // Add this line
    alert('EMI payment recorded successfully!');
}

function cancelEmiPaymentForm() {
    document.getElementById('emi-payment-form').classList.add('hidden');
}

function handleIncomePaymentModeChange() {
    const mode = document.getElementById('income-payment-mode').value;
    const cardSection = document.getElementById('income-debit-card-selection');
    if (mode === 'debit-card') {
        cardSection.classList.remove('hidden');
        populateIncomeDebitCards();
    } else {
        cardSection.classList.add('hidden');
    }
}

function populateIncomeDebitCards() {
    const debitCards = loadFromStorage('debitCards');
    const select = document.getElementById('income-debit-card');
    select.innerHTML = '<option value="">Choose Debit Card</option>';
    debitCards.forEach(card => {
        const option = document.createElement('option');
        option.value = card.id;
        option.textContent = `${card.bankName} - *${card.lastDigits}${card.nickname ? ' (' + card.nickname + ')' : ''}`;
        select.appendChild(option);
    });
}

// Documents functions
function handleDocumentUpload() {
    const files = document.getElementById('document-upload').files;
    if (!files.length) return;
    
    const documents = loadFromStorage('documents') || [];
    
    // Check if adding these files would exceed the limit
    if (documents.length + files.length > 6) {
        alert('Maximum 6 documents allowed. Please remove some documents first.');
        document.getElementById('document-upload').value = '';
        return;
    }
    
    Array.from(files).forEach(file => {
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const document = {
                id: generateId(),
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadedAt: new Date().toISOString()
            };
            
            documents.push(document);
            saveToStorage('documents', documents);
            displayDocuments();
        };
        reader.readAsDataURL(file);
    });
    
    document.getElementById('document-upload').value = '';
}

function displayDocuments() {
    const documents = loadFromStorage('documents') || [];
    const container = document.getElementById('documents-list');
    
    if (documents.length === 0) {
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6b7280;">No documents uploaded yet. Click the upload button to add important documents.</div>';
        return;
    }
    
    container.innerHTML = documents.map(doc => `
        <div class="item-card documents" style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">
                ${doc.type === 'application/pdf' ? '📄' : '🖼️'}
            </div>
            <div class="item-title" style="word-break: break-word; margin-bottom: 10px;">
                ${doc.name}
            </div>
            <div class="item-details" style="margin-bottom: 15px;">
                ${formatFileSize(doc.size)} • ${formatDate(doc.uploadedAt)}
            </div>
            <div class="item-actions" style="justify-content: center;">
                <button class="btn-edit" onclick="downloadDocument('${doc.id}')">Download</button>
                <button class="btn-delete" onclick="deleteDocument('${doc.id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

function downloadDocument(id) {
    const documents = loadFromStorage('documents') || [];
    const doc = documents.find(d => d.id === id);
    
    if (!doc) return;
    
    const link = document.createElement('a');
    link.href = doc.data;
    link.download = doc.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function deleteDocument(id) {
    if (confirm('Are you sure you want to delete this document?')) {
        let documents = loadFromStorage('documents') || [];
        documents = documents.filter(doc => doc.id !== id);
        saveToStorage('documents', documents);
        displayDocuments();
    }
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

// Documents functions
function initializeDocumentCards() {
    const documents = loadFromStorage('documents') || Array(6).fill(null);
    const container = document.getElementById('documents-container');
    
    container.innerHTML = '';
    
    for (let i = 0; i < 6; i++) {
        const doc = documents[i] || null;
        container.innerHTML += `
            <div class="item-card documents" style="border-left-color: #db2777; text-align: center; min-height: 220px;">
                <div style="font-size: 48px; margin: 15px 0; color: ${doc ? '#db2777' : '#d1d5db'};">
                    ${doc ? (doc.type === 'application/pdf' ? '📄' : '🖼️') : '📁'}
                </div>
                
                ${doc ? `
                    <div class="item-title" style="word-break: break-word; margin-bottom: 5px; font-weight: bold;">
                        ${doc.customName || doc.name}
                    </div>
                    <div class="item-details" style="margin-bottom: 5px; font-size: 12px; color: #6b7280;">
                        Original: ${doc.name}
                    </div>
                    <div class="item-details" style="margin-bottom: 15px;">
                        ${formatFileSize(doc.size)} • ${formatDate(doc.uploadedAt)}
                    </div>
                ` : `
                    <div class="item-details" style="margin-bottom: 15px; color: #6b7280;">
                        Slot ${i+1} - Empty
                    </div>
                `}
                
                <div class="item-actions" style="justify-content: center; gap: 8px;">
                    ${doc ? `
                        <button class="btn-edit" onclick="renameDocument(${i})" style="background: #3b82f6;">Rename</button>
                        <button class="btn-edit" onclick="downloadDocument(${i})">Download</button>
                        <button class="btn-delete" onclick="deleteDocument(${i})">Delete</button>
                    ` : `
                        <input type="file" id="doc-upload-${i}" style="display: none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload(${i})">
                        <button class="btn-edit" onclick="document.getElementById('doc-upload-${i}').click()">Upload</button>
                    `}
                </div>
            </div>
        `;
    }
}

function renameDocument(slotIndex) {
    const documents = loadFromStorage('documents') || [];
    const doc = documents[slotIndex];
    
    if (!doc) return;
    
    const currentName = doc.customName || doc.name;
    const newName = prompt('Enter a new name for this document:', currentName);
    
    if (newName && newName.trim() !== '') {
        documents[slotIndex].customName = newName.trim();
        saveToStorage('documents', documents);
        initializeDocumentCards();
    } else if (newName !== null) {
        alert('Document name cannot be empty.');
    }
}

function handleDocumentUpload(slotIndex) {
    const fileInput = document.getElementById(`doc-upload-${slotIndex}`);
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
        alert(`File ${file.name} is too large. Maximum size is 5MB.`);
        fileInput.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const documents = loadFromStorage('documents') || Array(6).fill(null);
        
        // Ask for custom name
        const customName = prompt('Enter a name for this document (or leave blank to use filename):', file.name.replace(/\.[^/.]+$/, ""));
        
        documents[slotIndex] = {
            id: generateId(),
            name: file.name,
            customName: customName ? customName.trim() : null,
            type: file.type,
            size: file.size,
            data: e.target.result,
            uploadedAt: new Date().toISOString(),
            slotIndex: slotIndex
        };
        
        saveToStorage('documents', documents);
        initializeDocumentCards();
    };
    reader.readAsDataURL(file);
}

function downloadDocument(slotIndex) {
    const documents = loadFromStorage('documents') || [];
    const doc = documents[slotIndex];
    
    if (!doc) return;
    
    const link = document.createElement('a');
    link.href = doc.data;
    // Use custom name for download if available, otherwise use original filename
    link.download = doc.customName || doc.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function deleteDocument(slotIndex) {
    if (confirm('Are you sure you want to delete this document?')) {
        const documents = loadFromStorage('documents') || [];
        documents[slotIndex] = null;
        saveToStorage('documents', documents);
        initializeDocumentCards();
    }
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

// Calculator functions
let calcExpression = '';
let calcResult = '';

function openCalculator() {
    document.getElementById('calculatorModal').style.display = 'flex';
    document.getElementById('calcDisplay').value = calcResult || '0';
}

function closeCalculator(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('calculatorModal').style.display = 'none';
}

function appendToCalc(value) {
    const display = document.getElementById('calcDisplay');
    
    if (display.value === '0' || display.value === calcResult) {
        display.value = value;
        calcExpression = value;
    } else {
        display.value += value;
        calcExpression += value;
    }
}

function clearCalc() {
    document.getElementById('calcDisplay').value = '0';
    calcExpression = '';
    calcResult = '';
}

function clearEntry() {
    const display = document.getElementById('calcDisplay');
    if (display.value.length > 1) {
        display.value = display.value.slice(0, -1);
        calcExpression = calcExpression.slice(0, -1);
    } else {
        display.value = '0';
        calcExpression = '';
    }
}

function calculateResult() {
    const display = document.getElementById('calcDisplay');
    try {
        // Replace × with * for calculation
        const expression = calcExpression.replace(/×/g, '*');
        const result = eval(expression);
        
        if (isFinite(result)) {
            calcResult = result.toString();
            display.value = calcResult;
            calcExpression = calcResult;
        } else {
            display.value = 'Error';
            calcExpression = '';
        }
    } catch (error) {
        display.value = 'Error';
        calcExpression = '';
    }
}

// Close calculator with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCalculator();
    }
});

// Calculator drag functionality
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let calculatorPosition = { x: 20, y: 20 }; // Default position

function initializeCalculatorDrag() {
    const calculatorBtn = document.querySelector('.floating-calculator');
    const calculatorModal = document.getElementById('calculatorModal');
    const calculatorContainer = document.querySelector('.calculator-container');
    
    // Make calculator button draggable
    calculatorBtn.addEventListener('mousedown', startDrag);
    calculatorBtn.addEventListener('touchstart', startDragTouch);
    
    // Make calculator modal draggable when open
    calculatorContainer.addEventListener('mousedown', startDragModal);
    calculatorContainer.addEventListener('touchstart', startDragModalTouch);
    
    // Update calculator position on load
    updateCalculatorPosition();
}

function startDrag(e) {
    isDragging = true;
    const calculatorBtn = document.querySelector('.floating-calculator');
    const rect = calculatorBtn.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    
    document.addEventListener('mousemove', doDrag);
    document.addEventListener('mouseup', stopDrag);
    e.preventDefault();
}

function startDragTouch(e) {
    isDragging = true;
    const calculatorBtn = document.querySelector('.floating-calculator');
    const touch = e.touches[0];
    const rect = calculatorBtn.getBoundingClientRect();
    dragOffsetX = touch.clientX - rect.left;
    dragOffsetY = touch.clientY - rect.top;
    
    document.addEventListener('touchmove', doDragTouch);
    document.addEventListener('touchend', stopDrag);
    e.preventDefault();
}

function startDragModal(e) {
    if (e.target.closest('.calculator-buttons')) return; // Don't drag if clicking buttons
    
    isDragging = true;
    const calculatorContainer = document.querySelector('.calculator-container');
    const rect = calculatorContainer.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    
    document.addEventListener('mousemove', doDragModal);
    document.addEventListener('mouseup', stopDrag);
    e.preventDefault();
}

function startDragModalTouch(e) {
    if (e.target.closest('.calculator-buttons')) return; // Don't drag if clicking buttons
    
    isDragging = true;
    const calculatorContainer = document.querySelector('.calculator-container');
    const touch = e.touches[0];
    const rect = calculatorContainer.getBoundingClientRect();
    dragOffsetX = touch.clientX - rect.left;
    dragOffsetY = touch.clientY - rect.top;
    
    document.addEventListener('touchmove', doDragModalTouch);
    document.addEventListener('touchend', stopDrag);
    e.preventDefault();
}

function doDrag(e) {
    if (!isDragging) return;
    
    calculatorPosition.x = e.clientX - dragOffsetX;
    calculatorPosition.y = e.clientY - dragOffsetY;
    
    // Keep within viewport bounds
    const calculatorBtn = document.querySelector('.floating-calculator');
    const btnWidth = calculatorBtn.offsetWidth;
    const btnHeight = calculatorBtn.offsetHeight;
    
    calculatorPosition.x = Math.max(0, Math.min(window.innerWidth - btnWidth, calculatorPosition.x));
    calculatorPosition.y = Math.max(0, Math.min(window.innerHeight - btnHeight, calculatorPosition.y));
    
    updateCalculatorPosition();
}

function doDragTouch(e) {
    if (!isDragging) return;
    
    const touch = e.touches[0];
    calculatorPosition.x = touch.clientX - dragOffsetX;
    calculatorPosition.y = touch.clientY - dragOffsetY;
    
    // Keep within viewport bounds
    const calculatorBtn = document.querySelector('.floating-calculator');
    const btnWidth = calculatorBtn.offsetWidth;
    const btnHeight = calculatorBtn.offsetHeight;
    
    calculatorPosition.x = Math.max(0, Math.min(window.innerWidth - btnWidth, calculatorPosition.x));
    calculatorPosition.y = Math.max(0, Math.min(window.innerHeight - btnHeight, calculatorPosition.y));
    
    updateCalculatorPosition();
}

function doDragModal(e) {
    if (!isDragging) return;
    
    const calculatorModal = document.getElementById('calculatorModal');
    calculatorModal.style.left = (e.clientX - dragOffsetX) + 'px';
    calculatorModal.style.top = (e.clientY - dragOffsetY) + 'px';
    calculatorModal.style.transform = 'none'; // Remove centering
}

function doDragModalTouch(e) {
    if (!isDragging) return;
    
    const touch = e.touches[0];
    const calculatorModal = document.getElementById('calculatorModal');
    calculatorModal.style.left = (touch.clientX - dragOffsetX) + 'px';
    calculatorModal.style.top = (touch.clientY - dragOffsetY) + 'px';
    calculatorModal.style.transform = 'none'; // Remove centering
}

function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', doDrag);
    document.removeEventListener('touchmove', doDragTouch);
    document.removeEventListener('mousemove', doDragModal);
    document.removeEventListener('touchmove', doDragModalTouch);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchend', stopDrag);
    
    // Save position to localStorage
    localStorage.setItem('calculatorPosition', JSON.stringify(calculatorPosition));
}

function updateCalculatorPosition() {
    const calculatorBtn = document.querySelector('.floating-calculator');
    calculatorBtn.style.left = calculatorPosition.x + 'px';
    calculatorBtn.style.top = calculatorPosition.y + 'px';
    calculatorBtn.style.bottom = 'auto'; // Remove bottom positioning
    calculatorBtn.style.right = 'auto'; // Remove right positioning
}

function loadCalculatorPosition() {
    const savedPosition = localStorage.getItem('calculatorPosition');
    if (savedPosition) {
        calculatorPosition = JSON.parse(savedPosition);
        updateCalculatorPosition();
    }
}
    </script>
</body>
</html>
